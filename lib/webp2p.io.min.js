/*! datachannel.min.js build:1.1.1, production. Copyright(c) 2013 Jesús Leganés Combarro "Piranna" <piranna@gmail.com> */(function(exports){function hex_sha1(e){return binb2hex(core_sha1(str2binb(e),e.length*chrsz))}function b64_sha1(e){return binb2b64(core_sha1(str2binb(e),e.length*chrsz))}function str_sha1(e){return binb2str(core_sha1(str2binb(e),e.length*chrsz))}function hex_hmac_sha1(e,t){return binb2hex(core_hmac_sha1(e,t))}function b64_hmac_sha1(e,t){return binb2b64(core_hmac_sha1(e,t))}function str_hmac_sha1(e,t){return binb2str(core_hmac_sha1(e,t))}function sha1_vm_test(){return hex_sha1("abc")=="a9993e364706816aba3e25717850c26c9cd0d89d"}function core_sha1(e,t){e[t>>5]|=128<<24-t%32,e[(t+64>>9<<4)+15]=t;var n=Array(80),r=1732584193,i=-271733879,s=-1732584194,o=271733878,u=-1009589776;for(var a=0;a<e.length;a+=16){var f=r,l=i,c=s,h=o,p=u;for(var d=0;d<80;d++){d<16?n[d]=e[a+d]:n[d]=rol(n[d-3]^n[d-8]^n[d-14]^n[d-16],1);var v=safe_add(safe_add(rol(r,5),sha1_ft(d,i,s,o)),safe_add(safe_add(u,n[d]),sha1_kt(d)));u=o,o=s,s=rol(i,30),i=r,r=v}r=safe_add(r,f),i=safe_add(i,l),s=safe_add(s,c),o=safe_add(o,h),u=safe_add(u,p)}return Array(r,i,s,o,u)}function sha1_ft(e,t,n,r){return e<20?t&n|~t&r:e<40?t^n^r:e<60?t&n|t&r|n&r:t^n^r}function sha1_kt(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function core_hmac_sha1(e,t){var n=str2binb(e);n.length>16&&(n=core_sha1(n,e.length*chrsz));var r=Array(16),i=Array(16);for(var s=0;s<16;s++)r[s]=n[s]^909522486,i[s]=n[s]^1549556828;var o=core_sha1(r.concat(str2binb(t)),512+t.length*chrsz);return core_sha1(i.concat(o),672)}function rol(e,t){return e<<t|e>>>32-t}function str2binb(e){var t=Array(),n=(1<<chrsz)-1;for(var r=0;r<e.length*chrsz;r+=chrsz)t[r>>5]|=(e.charCodeAt(r/chrsz)&n)<<32-chrsz-r%32;return t}function binb2str(e){var t="",n=(1<<chrsz)-1;for(var r=0;r<e.length*32;r+=chrsz)t+=String.fromCharCode(e[r>>5]>>>32-chrsz-r%32&n);return t}function binb2hex(e){var t=hexcase?"0123456789ABCDEF":"0123456789abcdef",n="";for(var r=0;r<e.length*4;r++)n+=t.charAt(e[r>>2]>>(3-r%4)*8+4&15)+t.charAt(e[r>>2]>>(3-r%4)*8&15);return n}function binb2b64(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="";for(var r=0;r<e.length*4;r+=3){var i=(e[r>>2]>>8*(3-r%4)&255)<<16|(e[r+1>>2]>>8*(3-(r+1)%4)&255)<<8|e[r+2>>2]>>8*(3-(r+2)%4)&255;for(var s=0;s<4;s++)r*8+s*6>e.length*32?n+=b64pad:n+=t.charAt(i>>6*(3-s)&63)}return n.replace(/AAA\=(\=*?)$/,"$1")}function hex_md5(e){return binl2hex(core_md5(str2binl(e),e.length*chrsz))}function b64_md5(e){return binl2b64(core_md5(str2binl(e),e.length*chrsz))}function str_md5(e){return binl2str(core_md5(str2binl(e),e.length*chrsz))}function hex_hmac_md5(e,t){return binl2hex(core_hmac_md5(e,t))}function b64_hmac_md5(e,t){return binl2b64(core_hmac_md5(e,t))}function str_hmac_md5(e,t){return binl2str(core_hmac_md5(e,t))}function md5_vm_test(){return hex_md5("abc")=="900150983cd24fb0d6963f7d28e17f72"}function core_md5(e,t){e[t>>5]|=128<<t%32,e[(t+64>>>9<<4)+14]=t;var n=1732584193,r=-271733879,i=-1732584194,s=271733878;for(var o=0;o<e.length;o+=16){var u=n,a=r,f=i,l=s;n=md5_ff(n,r,i,s,e[o+0],7,-680876936),s=md5_ff(s,n,r,i,e[o+1],12,-389564586),i=md5_ff(i,s,n,r,e[o+2],17,606105819),r=md5_ff(r,i,s,n,e[o+3],22,-1044525330),n=md5_ff(n,r,i,s,e[o+4],7,-176418897),s=md5_ff(s,n,r,i,e[o+5],12,1200080426),i=md5_ff(i,s,n,r,e[o+6],17,-1473231341),r=md5_ff(r,i,s,n,e[o+7],22,-45705983),n=md5_ff(n,r,i,s,e[o+8],7,1770035416),s=md5_ff(s,n,r,i,e[o+9],12,-1958414417),i=md5_ff(i,s,n,r,e[o+10],17,-42063),r=md5_ff(r,i,s,n,e[o+11],22,-1990404162),n=md5_ff(n,r,i,s,e[o+12],7,1804603682),s=md5_ff(s,n,r,i,e[o+13],12,-40341101),i=md5_ff(i,s,n,r,e[o+14],17,-1502002290),r=md5_ff(r,i,s,n,e[o+15],22,1236535329),n=md5_gg(n,r,i,s,e[o+1],5,-165796510),s=md5_gg(s,n,r,i,e[o+6],9,-1069501632),i=md5_gg(i,s,n,r,e[o+11],14,643717713),r=md5_gg(r,i,s,n,e[o+0],20,-373897302),n=md5_gg(n,r,i,s,e[o+5],5,-701558691),s=md5_gg(s,n,r,i,e[o+10],9,38016083),i=md5_gg(i,s,n,r,e[o+15],14,-660478335),r=md5_gg(r,i,s,n,e[o+4],20,-405537848),n=md5_gg(n,r,i,s,e[o+9],5,568446438),s=md5_gg(s,n,r,i,e[o+14],9,-1019803690),i=md5_gg(i,s,n,r,e[o+3],14,-187363961),r=md5_gg(r,i,s,n,e[o+8],20,1163531501),n=md5_gg(n,r,i,s,e[o+13],5,-1444681467),s=md5_gg(s,n,r,i,e[o+2],9,-51403784),i=md5_gg(i,s,n,r,e[o+7],14,1735328473),r=md5_gg(r,i,s,n,e[o+12],20,-1926607734),n=md5_hh(n,r,i,s,e[o+5],4,-378558),s=md5_hh(s,n,r,i,e[o+8],11,-2022574463),i=md5_hh(i,s,n,r,e[o+11],16,1839030562),r=md5_hh(r,i,s,n,e[o+14],23,-35309556),n=md5_hh(n,r,i,s,e[o+1],4,-1530992060),s=md5_hh(s,n,r,i,e[o+4],11,1272893353),i=md5_hh(i,s,n,r,e[o+7],16,-155497632),r=md5_hh(r,i,s,n,e[o+10],23,-1094730640),n=md5_hh(n,r,i,s,e[o+13],4,681279174),s=md5_hh(s,n,r,i,e[o+0],11,-358537222),i=md5_hh(i,s,n,r,e[o+3],16,-722521979),r=md5_hh(r,i,s,n,e[o+6],23,76029189),n=md5_hh(n,r,i,s,e[o+9],4,-640364487),s=md5_hh(s,n,r,i,e[o+12],11,-421815835),i=md5_hh(i,s,n,r,e[o+15],16,530742520),r=md5_hh(r,i,s,n,e[o+2],23,-995338651),n=md5_ii(n,r,i,s,e[o+0],6,-198630844),s=md5_ii(s,n,r,i,e[o+7],10,1126891415),i=md5_ii(i,s,n,r,e[o+14],15,-1416354905),r=md5_ii(r,i,s,n,e[o+5],21,-57434055),n=md5_ii(n,r,i,s,e[o+12],6,1700485571),s=md5_ii(s,n,r,i,e[o+3],10,-1894986606),i=md5_ii(i,s,n,r,e[o+10],15,-1051523),r=md5_ii(r,i,s,n,e[o+1],21,-2054922799),n=md5_ii(n,r,i,s,e[o+8],6,1873313359),s=md5_ii(s,n,r,i,e[o+15],10,-30611744),i=md5_ii(i,s,n,r,e[o+6],15,-1560198380),r=md5_ii(r,i,s,n,e[o+13],21,1309151649),n=md5_ii(n,r,i,s,e[o+4],6,-145523070),s=md5_ii(s,n,r,i,e[o+11],10,-1120210379),i=md5_ii(i,s,n,r,e[o+2],15,718787259),r=md5_ii(r,i,s,n,e[o+9],21,-343485551),n=safe_add(n,u),r=safe_add(r,a),i=safe_add(i,f),s=safe_add(s,l)}return Array(n,r,i,s)}function md5_cmn(e,t,n,r,i,s){return safe_add(bit_rol(safe_add(safe_add(t,e),safe_add(r,s)),i),n)}function md5_ff(e,t,n,r,i,s,o){return md5_cmn(t&n|~t&r,e,t,i,s,o)}function md5_gg(e,t,n,r,i,s,o){return md5_cmn(t&r|n&~r,e,t,i,s,o)}function md5_hh(e,t,n,r,i,s,o){return md5_cmn(t^n^r,e,t,i,s,o)}function md5_ii(e,t,n,r,i,s,o){return md5_cmn(n^(t|~r),e,t,i,s,o)}function core_hmac_md5(e,t){var n=str2binl(e);n.length>16&&(n=core_md5(n,e.length*chrsz));var r=Array(16),i=Array(16);for(var s=0;s<16;s++)r[s]=n[s]^909522486,i[s]=n[s]^1549556828;var o=core_md5(r.concat(str2binl(t)),512+t.length*chrsz);return core_md5(i.concat(o),640)}function safe_add(e,t){var n=(e&65535)+(t&65535),r=(e>>16)+(t>>16)+(n>>16);return r<<16|n&65535}function bit_rol(e,t){return e<<t|e>>>32-t}function str2binl(e){var t=Array(),n=(1<<chrsz)-1;for(var r=0;r<e.length*chrsz;r+=chrsz)t[r>>5]|=(e.charCodeAt(r/chrsz)&n)<<r%32;return t}function binl2str(e){var t="",n=(1<<chrsz)-1;for(var r=0;r<e.length*32;r+=chrsz)t+=String.fromCharCode(e[r>>5]>>>r%32&n);return t}function binl2hex(e){var t=hexcase?"0123456789ABCDEF":"0123456789abcdef",n="";for(var r=0;r<e.length*4;r++)n+=t.charAt(e[r>>2]>>r%4*8+4&15)+t.charAt(e[r>>2]>>r%4*8&15);return n}function binl2b64(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n="";for(var r=0;r<e.length*4;r+=3){var i=(e[r>>2]>>8*(r%4)&255)<<16|(e[r+1>>2]>>8*((r+1)%4)&255)<<8|e[r+2>>2]>>8*((r+2)%4)&255;for(var s=0;s<4;s++)r*8+s*6>e.length*32?n+=b64pad:n+=t.charAt(i>>6*(3-s)&63)}return n}function utf8t2d(e){e=e.replace(/\r\n/g,"\n");var t=new Array,n=String.fromCharCode(237);if(n.charCodeAt(0)<0)for(var r=0;r<e.length;r++){var i=e.charCodeAt(r);i>0?t[t.length]=i:(t[t.length]=256+i>>6|192,t[t.length]=256+i&63|128)}else for(var r=0;r<e.length;r++){var i=e.charCodeAt(r);i<128?t[t.length]=i:i>127&&i<2048?(t[t.length]=i>>6|192,t[t.length]=i&63|128):(t[t.length]=i>>12|224,t[t.length]=i>>6&63|128,t[t.length]=i&63|128)}return t}function utf8d2t(e){var t=new Array,n=0;while(n<e.length)e[n]<128?(t[t.length]=String.fromCharCode(e[n]),n++):e[n]>191&&e[n]<224?(t[t.length]=String.fromCharCode((e[n]&31)<<6|e[n+1]&63),n+=2):(t[t.length]=String.fromCharCode((e[n]&15)<<12|(e[n+1]&63)<<6|e[n+2]&63),n+=3);return t.join("")}function b64arrays(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";b64=new Array,f64=new Array;for(var t=0;t<e.length;t++)b64[t]=e.charAt(t),f64[e.charAt(t)]=t}function b64d2t(e){var t=new Array,n=0,r=e.length;r%3==1&&(e[e.length]=0,e[e.length]=0),r%3==2&&(e[e.length]=0);while(n<e.length)t[t.length]=b64[e[n]>>2],t[t.length]=b64[(e[n]&3)<<4|e[n+1]>>4],t[t.length]=b64[(e[n+1]&15)<<2|e[n+2]>>6],t[t.length]=b64[e[n+2]&63],n+=3;r%3==1&&(t[t.length-1]=t[t.length-2]="="),r%3==2&&(t[t.length-1]="=");var i=t.join("");return i}function b64t2d(e){var t=new Array,n=0;e=e.replace(/\n|\r/g,""),e=e.replace(/=/g,"");while(n<e.length)t[t.length]=f64[e.charAt(n)]<<2|f64[e.charAt(n+1)]>>4,t[t.length]=(f64[e.charAt(n+1)]&15)<<4|f64[e.charAt(n+2)]>>2,t[t.length]=(f64[e.charAt(n+2)]&3)<<6|f64[e.charAt(n+3)],n+=4;return e.length%4==2&&(t=t.slice(0,t.length-2)),e.length%4==3&&(t=t.slice(0,t.length-1)),t}function cnonce(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="";for(var r=0;r<e;r++)n+=t.charAt(Math.round(Math.random((new Date).getTime())*(t.length-1)));return n}function JSJaCJSON(){}function XmlHttp(){}function XmlDocument(){}function STANZA_ERROR(e,t,n){if(window==this)return new STANZA_ERROR(e,t,n);this.code=e,this.type=t,this.cond=n}function JSJaCConsoleLogger(e){this.level=e||4,this.start=function(){},this.log=function(e,t){t=t||0;if(t>this.level)return;if(typeof console=="undefined")return;try{switch(t){case 0:console.warn(e);break;case 1:console.error(e);break;case 2:console.info(e);break;case 4:console.debug(e);break;default:console.log(e)}}catch(n){try{console.log(e)}catch(n){}}},this.setLevel=function(e){return this.level=e,this},this.getLevel=function(){return this.level}}function JSJaCCookie(e,t,n,r,i){if(window==this)return new JSJaCCookie(e,t,n,r,i);this.name=e,this.value=t,this.secs=n,this.domain=r,this.path=i,this.write=function(){var e;if(this.secs){var t=new Date;t.setTime(t.getTime()+this.secs*1e3),e="; expires="+t.toGMTString()}else e="";var n=this.domain?"; domain="+this.domain:"",r=this.path?"; path="+this.path:"; path=/";document.cookie=this.getName()+"="+JSJaCCookie._escape(this.getValue())+e+n+r},this.erase=function(){var e=new JSJaCCookie(this.getName(),"",-1);e.write()},this.getName=function(){return this.name},this.setName=function(e){return this.name=e,this},this.getValue=function(){return this.value},this.setValue=function(e){return this.value=e,this},this.setDomain=function(e){return this.domain=e,this},this.setPath=function(e){return this.path=e,this}}function JSJaCCookieException(e){this.message=e,this.name="CookieException"}function JSJaCError(e,t,n){var r=XmlDocument.create("error","jsjac");return r.documentElement.setAttribute("code",e),r.documentElement.setAttribute("type",t),n&&r.documentElement.appendChild(r.createElement(n)).setAttribute("xmlns",NS_STANZAS),r.documentElement}function JSJaCJID(e){this._node="",this._domain="",this._resource="",typeof e=="string"?(e.indexOf("@")!=-1&&(this.setNode(e.substring(0,e.indexOf("@"))),e=e.substring(e.indexOf("@")+1)),e.indexOf("/")!=-1&&(this.setResource(e.substring(e.indexOf("/")+1)),e=e.substring(0,e.indexOf("/"))),this.setDomain(e)):(this.setNode(e.node),this.setDomain(e.domain),this.setResource(e.resource))}function JSJaCJIDInvalidException(e){this.message=e,this.name="JSJaCJIDInvalidException"}function JSJaCKeys(e,t){var n=Math.random();this._k=new Array,this._k[0]=n.toString(),t?this.oDbg=t:(this.oDbg={},this.oDbg.log=function(){});if(e)for(var r=1;r<JSJAC_NKEYS;r++)this._k[r]=e(this._k[r-1]),t.log(r+": "+this._k[r],4);this._indexAt=JSJAC_NKEYS-1,this.getKey=function(){return this._k[this._indexAt--]},this.lastKey=function(){return this._indexAt==0},this.size=function(){return this._k.length},this._getSuspendVars=function(){return"_k,_indexAt".split(",")}}function JSJaCPacket(e){this.name=e,typeof JSJACPACKET_USE_XMLNS!="undefined"&&JSJACPACKET_USE_XMLNS?this.doc=XmlDocument.create(e,NS_CLIENT):this.doc=XmlDocument.create(e,"")}function JSJaCPresence(){this.base=JSJaCPacket,this.base("presence")}function JSJaCIQ(){this.base=JSJaCPacket,this.base("iq")}function JSJaCMessage(){this.base=JSJaCPacket,this.base("message")}function JSJaCConnection(e){e&&e.httpbase&&(this._httpbase=e.httpbase),e&&e.oDbg&&e.oDbg.log?this.oDbg=e.oDbg:this.oDbg={log:function(){}},e&&e.timerval?this.setPollInterval(e.timerval):this.setPollInterval(JSJAC_TIMERVAL),e&&e.cookie_prefix?this._cookie_prefix=e.cookie_prefix:this._cookie_prefix="",this._connected=!1,this._events=[],this._keys=null,this._ID=0,this._inQ=[],this._pQueue=[],this._regIDs=[],this._req=[],this._status="intialized",this._errcnt=0,this._inactivity=JSJAC_INACTIVITY,this._sendRawCallbacks=[]}function JSJaCHttpBindingConnection(e){this.base=JSJaCConnection,this.base(e),this._hold=JSJACHBC_MAX_HOLD,this._inactivity=0,this._last_requests={},this._last_rid=0,this._min_polling=0,this._pause=0,this._wait=e.wait||JSJACHBC_MAX_WAIT}function JSJaCWebSocketConnection(e){this.base=JSJaCConnection,this.base(e),this._ws=null,this.registerHandler("onerror",JSJaC.bind(this._cleanupWebSocket,this))}function JSJaCFBApplication(e){e&&e.appID&&(this._appID=e.appID),e&&e.apiKey&&(this._apiKey=e.apiKey),e&&e.apiSecret&&(this._apiSecret=e.apiSecret),this._perms="",this._session=undefined}function SimpleSignaling(e){var t=this,n=function s(e){return e?(e^Math.random()*16>>e/4).toString(16):([1e7]+ -1e3+ -4e3+ -8e3+ -1e11).replace(/[018]/g,s)},r=e.uid!=undefined?e.uid:n(),i=new WebSocket(e.ws_uri);i.onopen=function(){i.onmessage=function(e){e=JSON.parse(e.data);var n=e[0],r=e[1],i=e[2];t.onmessage&&t.onmessage(i,n,r)},i.send(JSON.stringify([r,e.room])),t.onopen&&t.onopen()},this.send=function(e,n,r){i.send(JSON.stringify([n,r,e]),function(e){e&&t.onerror&&t.onerror(e)})},this.uid=function(){return r}}function WebP2P(e,t,n){function u(e){Object.keys(e.channels).length||e.close()}function a(){if(s.status=="disconnected"){var e=document.createEvent("Event");e.initEvent("disconnected",!0,!0),s.dispatchEvent(e)}}function f(e,t){var o=i[e]=new r({iceServers:[{url:"stun:"+n}]},{optional:[{RtpDataChannels:!0}]});o.onerror=function(e){console.error(e)},o.onicecandidate=function(n){n.candidate&&t.sendCandidate(e,n.candidate)},o.onstatechange=function(t){t.target.readyState=="closed"&&(delete i[e],a())},applyChannelsShim(o),o.addEventListener("datachannel",function(t){var n=t.channel;n.addEventListener("close",function(e){u(o)}),n.label==s.routingLabel&&l(o,n,e)});var f=document.createEvent("Event");return f.initEvent("peerconnection",!0,!0),f.peerconnection=o,f.uid=e,s.dispatchEvent(f),o}function l(e,t,n){t.addEventListener("error",function(e){console.error(e)}),EventTarget.call(t),t.onmessage=function(e){e=JSON.parse(e),e.from=t.uid,s.dispatchEvent(e)},t.sendData=function(e,n){e.dest=n,t.send(JSON.stringify(e))},Transport_Routing_init(t,s,n)}var r=r||webkitRTCPeerConnection||mozRTCPeerConnection;this.commonLabels=t||[],n==undefined&&(n="stun.l.google.com:19302");var i={},s=this;this.routingLabel="webp2p";var o=function h(e){return e?(e^Math.random()*16>>e/4).toString(16):([1e7]+ -1e3+ -4e3+ -8e3+ -1e11).replace(/[018]/g,h)};this.uid=o(),this.onoffer=function(e,t,n,r){function o(e){r(e)}var s=i[e];s||(s=f(e,n)),s.setRemoteDescription(new RTCSessionDescription({sdp:t,type:"offer"}),function(){s.createAnswer(function(e){s.setLocalDescription(new RTCSessionDescription({sdp:e.sdp,type:"answer"}),function(){r(null,e.sdp)},function(t){r(t,e.sdp)})},o)},o)},this.onanswer=function(e,t,n){var r=i[e];r?r.setRemoteDescription(new RTCSessionDescription({sdp:t,type:"answer"}),function(){console.info("Received answer for UID "+e)},n):n("PeerConnection '"+e+"' not found")},this.oncandidate=function(e,t,n){var r=i[e];r?r.addIceCandidate(new RTCIceCandidate(t)):n&&n(e)};var c=new HandshakeManager(this.uid);e instanceof Array?c.addConfigs_byArray(e):c.addConfigs_byUri(e),c.onerror=function(e){var t=document.createEvent("Event");t.initEvent("error",!0,!0),t.error=e.error,s.dispatchEvent(t)},c.onconnected=function(e){var t=e.channel;Transport_Presence_init(t,s);var n=document.createEvent("Event");n.initEvent("connected",!0,!0),n.uid=s.uid,s.dispatchEvent(n)},c.addEventListener("disconnected",a),this.__defineGetter__("status",function(){return Object.keys(i).length?"connected":c.status}),this.connectTo=function(e,t,n,r){function p(e){r(e)}t||(t=[]);var s=!1,o=i[e];o||(s=!0,o=f(e,n),o.channels[this.routingLabel]=o.createDataChannel(this.routingLabel),l(o,o.channels[this.routingLabel],e)),t=this.commonLabels.concat(t);for(var u=0,a;a=t[u];u++){var c=o.channels[a];if(!c){s=!0,c=o.createDataChannel(a),o.channels[a]=c;var h=document.createEvent("Event");h.initEvent("datachannel",!0,!0),h.channel=c,o.dispatchEvent(h)}}s?o.createOffer(function(t){if(n)n.sendOffer(e,t.sdp);else for(var s in i)i[s].channels[this.routingLabel].sendOffer(e,t.sdp);o.setLocalDescription(t,r,p)},p):r()},this.getPeers=function(){return i}}function applyChannelsShim(e){if(e.channels!=undefined)return;var t={};e.__defineGetter__("channels",function(){return t});var n=e.dispatchEvent;e.dispatchEvent=function(e){if(e.type=="datachannel"){var r=e.channel;t[r.label]=r,r.addEventListener("close",function(e){delete t[r.label]})}n.call(this,e)}}function HandshakeManager(e){function s(){if(i==undefined||!r.length)throw Error("No handshake servers defined");n="connecting";for(;i<r.length;i++){var o=r[i][0],u=r[i][1];u.uid=e;var a=HandshakeManager.handshakeServers[o];if(a){var f=new a(u);f.max_connections=u.max_connections,f.uid=o,f.addEventListener("open",function(e){n="connected";var e=document.createEvent("Event");e.initEvent(n,!0,!0),e.channel=f,t.dispatchEvent(e)}),f.addEventListener("close",function(e){i++,s()});break}console.error("Invalid handshake server type '"+o+"'")}n="disconnected";var l=document.createEvent("Event");l.initEvent(n,!0,!0),l.channel=f,t.dispatchEvent(l),i=0}var t=this,n="disconnected",r=[],i;this.__defineGetter__("status",function(){return n}),this.addConfigs_byArray=function(e){r=r.concat(e),n=="disconnected"&&(i==undefined&&(i=0),s())},this.addConfigs_byUri=function(e){function n(e){var n=document.createEvent("Event");n.initEvent("error",!0,!0),n.error=e,t.dispatchEvent(n)}var r=new XMLHttpRequest;r.open("GET",e),r.onload=function(e){if(this.status==200){var t=JSON.parse(r.response);t.length?this.addConfigs_byArray(t):n(ERROR_REQUEST_EMPTY)}else n(ERROR_REQUEST_FAILURE)},r.onerror=function(e){n(navigator.onLine?ERROR_NETWORK_UNKNOWN:ERROR_NETWORK_OFFLINE)},r.send()}}function HandshakeConnector(){var e=this;this.connect=function(){e.presence();var t=document.createEvent("Event");t.initEvent("open",!0,!0),e.dispatchEvent(t)},this.dispatchMessageEvent=function(t,n){if(t.from==n)return;e.dispatchEvent(t)},this.dispatchPresence=function(t){var n=document.createEvent("Event");n.initEvent("presence",!0,!0),n.from=t,e.dispatchMessageEvent(n)},this.error=function(t){e.dispatchEvent(t)}}function Handshake_PubNub(e){HandshakeConnector.call(this);var t=this,n=PUBNUB.init(e);n.subscribe({channel:e.channel,callback:function(n){t.dispatchMessageEvent(n,e.uid)},connect:t.connect,error:t.error}),this.close=function(){n.unsubscribe({channel:e.channel})},this.presence=function(){t.sendData({type:"presence"})},this.sendData=function(t,r){t.from=e.uid,t.dest=r,n.publish({channel:e.channel,message:t})}}function Handshake_SimpleSignaling(e){HandshakeConnector.call(this);var t=this,n=new SimpleSignaling(e);n.onmessage=function(n){var r=JSON.parse(n.data);t.dispatchMessageEvent(r,e.uid)},n.onopen=t.connect,n.onerror=t.error,this.close=function(){n.close()},this.presence=function(){t.send({type:"presence",from:e.uid})},this.sendData=function(t,r){t.from=e.uid,t.to=r,n.send(JSON.stringify(t))}}function Handshake_XMPP(e){HandshakeConnector.call(this);var t=this,n=new JSJaCHttpBindingConnection(e);n.connect(e),n.registerHandler("message",function(n){var r=n.getBody();if(r=="")return;var i=JSON.parse(r);i.from=n.getFromJID().getResource(),t.dispatchMessageEvent(i,e.uid)}),n.registerHandler("onconnect",t.connect),n.registerHandler("onerror",t.error),this.close=function(){n.disconnect()},this.presence=function(){var r=new JSJaCPresence;r.setTo(e.room+"/"+e.uid),n.send(r),setTimeout(function(){n.registerHandler("presence",function(e){if(!e.getType()&&!e.getShow()){var n=e.getFromJID().getResource();t.dispatchPresence(n)}})},1e3)},this.sendData=function(t,r){var i=new JSJaCMessage;i.setTo(e.room+"/"+r),i.setBody(JSON.stringify(t)),n.send(i)}}function Transport_Presence_init(e,t){Transport_Routing_init(e,t),e.connections=0,e.addEventListener("presence",function(n){var r=n.from;t.connectTo(r,this.commonLabels,e,function(t){t?console.error(r,this.commonLabels,e,t):e.connections++,e.connections==e.max_connections&&e.close()})}),e.onerror=function(t){console.error(t),e.close()}}function Transport_Routing_init(e,t,n){function r(e,r,i){var s=e.from,o=e.dest,u=e.route||[],a=e.sdp,f=u.lenght?u[0]:s;if(s==t.uid)return;for(var l=0,c;c=u[l];l++)if(c==t.uid)return;if(o==t.uid)r(f,a,u);else{u.push(n);var h=t.getPeers(),p=h[o];if(p)p._routing[i](o,a,u);else for(var c in h){if(c==n)continue;var d=!1;for(var l=0,v;v=u[l];l++)if(v==c){d=!0;break}d||h[c]._routing[i](o,a,u)}}}function i(e,r,i){var s=e.from,o=e.dest,u=e.route||[],a=e.sdp,f=u.lenght?u[0]:s;if(s==t.uid)return;if(o==t.uid)r(f,a,u);else if(u.length){var l=!1,c=t.getPeers();for(var h=0,p;d=u[h];h++)for(var d in c)p==d&&(c[d]._routing[i](o,a,u.slice(0,h-1)),l=!0);if(!l){u=u.slice(0,u.length-1);for(var d in c){if(d==n)continue;var l=!1;for(var h=0,v;v=u[h];h++)if(v==d){l=!0;break}l||c[d]._routing[i](o,a,u)}}}else console.warn("["+i+"] Wrong destination and route is empty")}e.addEventListener("offer",function(n){r(n,function(n,r,i){t.onoffer(n,r,e,function(r,s){if(r)console.error(r);else{console.log("[createAnswer]: "+n+"\n"+s);var o=t.getPeers();for(var u=0,a;f=i[u];u++)for(var f in o)if(a==f){o[f]._routing.sendAnswer(n,s,i);return}e.sendAnswer(n,s,i)}})},"sendOffer")}),e.addEventListener("answer",function(e){i(e,function(e,n,r){t.onanswer(e,n,function(e){console.error(e)})},"sendAnswer")}),e.addEventListener("candidate",function(e){r(e,function(e,n,r){t.oncandidate(e,n,function(e){console.error("[routing.candidate] PeerConnection '"+e+"' not found")})},"sendCandidate")}),e.sendAnswer=function(t,r,i){var s={type:"answer",sdp:r};for(var o=0,u;u=i[o];o++)if(u==n){i.length=o;break}i&&i.length&&(s.route=i),e.sendData(s,t)},e.sendCandidate=function(t,n,r){var i={type:"candidate",sdp:n};r&&r.length&&(i.route=r),e.sendData(i,t)},e.sendOffer=function(t,n,r){var i={type:"offer",sdp:n};r&&r.length&&(i.route=r),e.sendData(i,t)}}JSJAC_HAVEKEYS=!0,JSJAC_NKEYS=16,JSJAC_INACTIVITY=300,JSJAC_ERR_COUNT=10,JSJAC_ALLOW_PLAIN=!0,JSJAC_CHECKQUEUEINTERVAL=100,JSJAC_CHECKINQUEUEINTERVAL=100,JSJAC_TIMERVAL=2e3,JSJAC_RETRYDELAY=5e3,JSJACHBC_MAX_HOLD=1,JSJACHBC_MAX_WAIT=300,JSJACHBC_BOSH_VERSION="1.6",JSJACHBC_USE_BOSH_VER=!0,JSJACHBC_MAXPAUSE=120,String.prototype.htmlEnc=function(){if(!this)return this;var e=this.replace(/&/g,"&amp;");return e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/\"/g,"&quot;"),e=e.replace(/\n/g,"<br />"),e},String.prototype.revertHtmlEnc=function(){if(!this)return this;var e=this.replace(/&amp;/gi,"&");return e=e.replace(/&lt;/gi,"<"),e=e.replace(/&gt;/gi,">"),e=e.replace(/&quot;/gi,'"'),e=e.replace(/<br( )?(\/)?>/gi,"\n"),e},Date.jab2date=function(e){var t=new Date(Date.UTC(e.substr(0,4),e.substr(5,2)-1,e.substr(8,2),e.substr(11,2),e.substr(14,2),e.substr(17,2)));if(e.substr(e.length-6,1)!="Z"){var n=new Date;n.setTime(0),n.setUTCHours(e.substr(e.length-5,2)),n.setUTCMinutes(e.substr(e.length-2,2)),e.substr(e.length-6,1)=="+"?t.setTime(t.getTime()-n.getTime()):e.substr(e.length-6,1)=="-"&&t.setTime(t.getTime()+n.getTime())}return t},Date.hrTime=function(e){return Date.jab2date(e).toLocaleString()},Date.prototype.jabberDate=function(){var e=function(e){return e<10?"0"+e:e},t=this.getUTCFullYear()+"-";return t+=e(this.getUTCMonth()+1)+"-",t+=e(this.getUTCDate())+"T",t+=e(this.getUTCHours())+":",t+=e(this.getUTCMinutes())+":",t+=e(this.getUTCSeconds())+"Z",t},Number.max=function(e,t){return e>t?e:t},Number.min=function(e,t){return e<t?e:t},window.XDomainRequest&&(window.ieXDRToXHR=function(e){"use strict";var t=e.XMLHttpRequest;e.XMLHttpRequest=function(){this.onreadystatechange=Object,this.xhr=null,this.xdr=null,this.readyState=0,this.status="",this.statusText=null,this.responseText=null,this.getResponseHeader=null,this.getAllResponseHeaders=null,this.setRequestHeader=null,this.abort=null,this.send=null,this.isxdr=!1;var e=this;e.xdrLoadedBinded=function(){e.xdrLoaded()},e.xdrErrorBinded=function(){e.xdrError()},e.xdrProgressBinded=function(){e.xdrProgress()},e.xhrReadyStateChangedBinded=function(){e.xhrReadyStateChanged()}},XMLHttpRequest.prototype.open=function(n,r,i,s,o){var u=document.createElement("a");u.href=r,u.hostname!=document.domain?(this.xdr===null&&(this.xdr=new e.XDomainRequest),this.isxdr=!0,this.setXDRActive(),this.xdr.open(n,r)):(this.xhr===null&&(this.xhr=new t),this.isxdr=!1,this.setXHRActive(),this.xhr.open(n,r,i,s,o))},XMLHttpRequest.prototype.xdrGetResponseHeader=function(e){return e==="Content-Type"&&this.xdr.contentType>""?this.xdr.contentType:""},XMLHttpRequest.prototype.xdrGetAllResponseHeaders=function(){return this.xdr.contentType>""?"Content-Type: "+this.xdr.contentType:""},XMLHttpRequest.prototype.xdrSetRequestHeader=function(e,t){},XMLHttpRequest.prototype.xdrLoaded=function(){if(this.onreadystatechange!==null){this.readyState=4,this.status=200,this.statusText="OK",this.responseText=this.xdr.responseText;if(e.ActiveXObject){var t=new ActiveXObject("Microsoft.XMLDOM");t.async="false",t.loadXML(this.responseText),this.responseXML=t}this.onreadystatechange()}},XMLHttpRequest.prototype.xdrError=function(){this.onreadystatechange!==null&&(this.readyState=4,this.status=0,this.statusText="",this.responseText="",this.onreadystatechange())},XMLHttpRequest.prototype.xdrProgress=function(){this.onreadystatechange!==null&&this.status!==3&&(this.readyState=3,this.status=3,this.statusText="",this.onreadystatechange())},XMLHttpRequest.prototype.finalXDRRequest=function(){var e=this.xdr;delete e.onload,delete e.onerror,delete e.onprogress},XMLHttpRequest.prototype.sendXDR=function(e){var t=this.xdr;t.onload=this.xdrLoadedBinded,t.onerror=this.xdr.ontimeout=this.xdrErrorBinded,t.onprogress=this.xdrProgressBinded,this.responseText=null,this.xdr.send(e)},XMLHttpRequest.prototype.abortXDR=function(){this.finalXDRRequest(),this.xdr.abort()},XMLHttpRequest.prototype.setXDRActive=function(){this.send=this.sendXDR,this.abort=this.abortXDR,this.getResponseHeader=this.xdrGetResponseHeader,this.getAllResponseHeaders=this.xdrGetAllResponseHeaders,this.setRequestHeader=this.xdrSetRequestHeader},XMLHttpRequest.prototype.xhrGetResponseHeader=function(e){return this.xhr.getResponseHeader(e)},XMLHttpRequest.prototype.xhrGetAllResponseHeaders=function(){return this.xhr.getAllResponseHeaders()},XMLHttpRequest.prototype.xhrSetRequestHeader=function(e,t){return this.xhr.setRequestHeader(e,t)},XMLHttpRequest.prototype.xhrReadyStateChanged=function(){if(this.onreadystatechange!==null&&this.readyState!==this.xhr.readyState){var e=this.xhr;this.readyState=e.readyState,this.readyState===4&&(this.status=e.status,this.statusText=e.statusText,this.responseText=e.responseText,this.responseXML=e.responseXML),this.onreadystatechange()}},XMLHttpRequest.prototype.finalXHRRequest=function(){delete this.xhr.onreadystatechange},XMLHttpRequest.prototype.abortXHR=function(){this.finalXHRRequest(),this.xhr.abort()},XMLHttpRequest.prototype.sendXHR=function(e){this.xhr.onreadystatechange=this.xhrReadyStateChangedBinded,this.xhr.send(e)},XMLHttpRequest.prototype.setXHRActive=function(){this.send=this.sendXHR,this.abort=this.abortXHR,this.getResponseHeader=this.xhrGetResponseHeader,this.getAllResponseHeaders=this.xhrGetAllResponseHeaders,this.setRequestHeader=this.xhrSetRequestHeader},e.ieXDRToXHR=undefined},window.ieXDRToXHR(window));var hexcase=0,b64pad="=",chrsz=8;(typeof atob=="undefined"||typeof btoa=="undefined")&&b64arrays(),typeof atob=="undefined"?b64decode=function(e){return utf8d2t(b64t2d(e))}:b64decode=function(e){return decodeURIComponent(escape(atob(e)))},typeof btoa=="undefined"?b64encode=function(e){return b64d2t(utf8t2d(e))}:b64encode=function(e){return btoa(unescape(encodeURIComponent(e)))},JSJaCJSON.toString=function(e){var t={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},n={array:function(e){var t=["["],r,i,o,u=e.length,a;for(o=0;o<u;o+=1){a=e[o],i=n[typeof a];if(i)try{a=i(a),typeof a=="string"&&(r&&(t[t.length]=","),t[t.length]=a,r=!0)}catch(f){}}return t[t.length]="]",t.join("")},"boolean":function(e){return String(e)},"null":function(e){return"null"},number:function(e){return isFinite(e)?String(e):"null"},object:function(e){if(e){if(e instanceof Array)return n.array(e);var t=["{"],r,i,o,u;for(o in e)if(e.hasOwnProperty(o)){u=e[o],i=n[typeof u];if(i)try{u=i(u),typeof u=="string"&&(r&&(t[t.length]=","),t.push(n.string(o),":",u),r=!0)}catch(a){}}return t[t.length]="}",t.join("")}return"null"},string:function(e){return/["\\\x00-\x1f]/.test(e)&&(e=e.replace(/([\x00-\x1f\\"])/g,function(e,n){var r=t[n];return r?r:(r=n.charCodeAt(),"\\u00"+Math.floor(r/16).toString(16)+(r%16).toString(16))})),'"'+e+'"'}};switch(typeof e){case"object":return n.object(e);case"array":return n.array(e)}},JSJaCJSON.parse=function(str){try{return!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(str.replace(/"(\\.|[^"\\])*"/g,""))&&eval("("+str+")")}catch(e){return!1}},XmlHttp.create=function(){try{if(window.XMLHttpRequest){var e=new XMLHttpRequest;return e.readyState===null&&(e.readyState=1,e.addEventListener("load",function(){e.readyState=4,typeof e.onreadystatechange=="function"&&e.onreadystatechange()},!1)),e}if(window.ActiveXObject)return new ActiveXObject(XmlHttp.getPrefix()+".XmlHttp")}catch(t){}throw new Error("Your browser does not support XmlHttp objects")},XmlHttp.getPrefix=function(){if(XmlHttp.prefix)return XmlHttp.prefix;var e=["MSXML2","Microsoft","MSXML","MSXML3"],t;for(var n=0;n<e.length;n++)try{return t=new ActiveXObject(e[n]+".XmlHttp"),XmlHttp.prefix=e[n]}catch(r){}throw new Error("Could not find an installed XML parser")},XmlDocument.create=function(e,t){e=e||"foo",t=t||"";try{var n;document.implementation&&document.implementation.createDocument?(n=document.implementation.createDocument(t,e,null),n.readyState===null&&(n.readyState=1,n.addEventListener("load",function(){n.readyState=4,typeof n.onreadystatechange=="function"&&n.onreadystatechange()},!1))):window.ActiveXObject&&(n=new ActiveXObject(XmlDocument.getPrefix()+".DomDocument"));if(!n.documentElement||n.documentElement.tagName!=e||n.documentElement.namespaceURI&&n.documentElement.namespaceURI!=t)try{t!==""?n.appendChild(n.createElement(e)).setAttribute("xmlns",t):n.appendChild(n.createElement(e))}catch(r){n=document.implementation.createDocument(t,e,null),n.documentElement===null&&n.appendChild(n.createElement(e)),t!==""&&n.documentElement.getAttribute("xmlns")!=t&&n.documentElement.setAttribute("xmlns",t)}return n}catch(i){}throw new Error("Your browser does not support XmlDocument objects")},XmlDocument.getPrefix=function(){if(XmlDocument.prefix)return XmlDocument.prefix;var e=["MSXML2","Microsoft","MSXML","MSXML3"],t;for(var n=0;n<e.length;n++)try{return t=new ActiveXObject(e[n]+".DomDocument"),XmlDocument.prefix=e[n]}catch(r){}throw new Error("Could not find an installed XML parser")},typeof Document!="undefined"&&window.DOMParser&&(Document.prototype.loadXML=function(e){var t=(new DOMParser).parseFromString(e,"text/xml");while(this.hasChildNodes())this.removeChild(this.lastChild);for(var n=0;n<t.childNodes.length;n++)this.appendChild(this.importNode(t.childNodes[n],!0))}),window.XMLSerializer&&window.Node&&Node.prototype&&Node.prototype.__defineGetter__&&(XMLDocument.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Document.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}),Node.prototype.__defineGetter__("xml",function(){return(new XMLSerializer).serializeToString(this)}));var JSJaCBuilder={buildNode:function(e,t){var n,r=arguments[4];if(arguments[2])if(JSJaCBuilder._isStringOrNumber(arguments[2])||arguments[2]instanceof Array)n=this._createElement(e,t,r),JSJaCBuilder._children(e,n,arguments[2]);else{r=arguments[2].xmlns||r,n=this._createElement(e,t,r);for(var i in arguments[2])arguments[2].hasOwnProperty(i)&&i!="xmlns"&&n.setAttribute(i,arguments[2][i])}else n=this._createElement(e,t,r);return arguments[3]&&JSJaCBuilder._children(e,n,arguments[3],r),n},_createElement:function(e,t,n){try{if(n)return e.createElementNS(n,t)}catch(r){}var i=e.createElement(t);return n&&i.setAttribute("xmlns",n),i},_text:function(e,t){return e.createTextNode(t)},_children:function(e,t,n,r){if(typeof n=="object"){for(var i in n)if(n.hasOwnProperty(i)){var s=n[i];if(typeof s=="object")if(s instanceof Array){var o=JSJaCBuilder.buildNode(e,s[0],s[1],s[2],r);t.appendChild(o)}else t.appendChild(s);else JSJaCBuilder._isStringOrNumber(s)&&t.appendChild(JSJaCBuilder._text(e,s))}}else JSJaCBuilder._isStringOrNumber(n)&&t.appendChild(JSJaCBuilder._text(e,n))},_attributes:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n+'="'+e[n].toString().htmlEnc()+'"');return t.join(" ")},_isStringOrNumber:function(e){return typeof e=="string"||typeof e=="number"}},NS_DISCO_ITEMS="http://jabber.org/protocol/disco#items",NS_DISCO_INFO="http://jabber.org/protocol/disco#info",NS_VCARD="vcard-temp",NS_AUTH="jabber:iq:auth",NS_AUTH_ERROR="jabber:iq:auth:error",NS_REGISTER="jabber:iq:register",NS_SEARCH="jabber:iq:search",NS_ROSTER="jabber:iq:roster",NS_PRIVACY="jabber:iq:privacy",NS_PRIVATE="jabber:iq:private",NS_VERSION="jabber:iq:version",NS_TIME="jabber:iq:time",NS_TIME_NEW="urn:xmpp:time",NS_LAST="jabber:iq:last",NS_XDATA="jabber:x:data",NS_IQDATA="jabber:iq:data",NS_DELAY="jabber:x:delay",NS_DELAY_NEW="urn:xmpp:delay",NS_EXPIRE="jabber:x:expire",NS_EVENT="jabber:x:event",NS_XCONFERENCE="jabber:x:conference",NS_PING="urn:xmpp:ping",NS_CHAT_STATES="http://jabber.org/protocol/chatstates",NS_STATS="http://jabber.org/protocol/stats",NS_MUC="http://jabber.org/protocol/muc",NS_MUC_USER="http://jabber.org/protocol/muc#user",NS_MUC_ADMIN="http://jabber.org/protocol/muc#admin",NS_MUC_OWNER="http://jabber.org/protocol/muc#owner",NS_PUBSUB="http://jabber.org/protocol/pubsub",NS_PUBSUB_EVENT="http://jabber.org/protocol/pubsub#event",NS_PUBSUB_OWNER="http://jabber.org/protocol/pubsub#owner",NS_PUBSUB_NMI="http://jabber.org/protocol/pubsub#node-meta-info",NS_COMMANDS="http://jabber.org/protocol/commands",NS_STREAM="http://etherx.jabber.org/streams",NS_CLIENT="jabber:client",NS_BOSH="http://jabber.org/protocol/httpbind",NS_XBOSH="urn:xmpp:xbosh",NS_STANZAS="urn:ietf:params:xml:ns:xmpp-stanzas",NS_STREAMS="urn:ietf:params:xml:ns:xmpp-streams",NS_TLS="urn:ietf:params:xml:ns:xmpp-tls",NS_SASL="urn:ietf:params:xml:ns:xmpp-sasl",NS_SESSION="urn:ietf:params:xml:ns:xmpp-session",NS_BIND="urn:ietf:params:xml:ns:xmpp-bind",NS_FEATURE_IQAUTH="http://jabber.org/features/iq-auth",NS_FEATURE_IQREGISTER="http://jabber.org/features/iq-register",NS_FEATURE_COMPRESS="http://jabber.org/features/compress",NS_COMPRESS="http://jabber.org/protocol/compress",ERR_BAD_REQUEST=STANZA_ERROR("400","modify","bad-request"),ERR_CONFLICT=STANZA_ERROR("409","cancel","conflict"),ERR_FEATURE_NOT_IMPLEMENTED=STANZA_ERROR("501","cancel","feature-not-implemented"),ERR_FORBIDDEN=STANZA_ERROR("403","auth","forbidden"),ERR_GONE=STANZA_ERROR("302","modify","gone"),ERR_INTERNAL_SERVER_ERROR=STANZA_ERROR("500","wait","internal-server-error"),ERR_ITEM_NOT_FOUND=STANZA_ERROR("404","cancel","item-not-found"),ERR_JID_MALFORMED=STANZA_ERROR("400","modify","jid-malformed"),ERR_NOT_ACCEPTABLE=STANZA_ERROR("406","modify","not-acceptable"),ERR_NOT_ALLOWED=STANZA_ERROR("405","cancel","not-allowed"),ERR_NOT_AUTHORIZED=STANZA_ERROR("401","auth","not-authorized"),ERR_PAYMENT_REQUIRED=STANZA_ERROR("402","auth","payment-required"),ERR_RECIPIENT_UNAVAILABLE=STANZA_ERROR("404","wait","recipient-unavailable"),ERR_REDIRECT=STANZA_ERROR("302","modify","redirect"),ERR_REGISTRATION_REQUIRED=STANZA_ERROR("407","auth","registration-required"),ERR_REMOTE_SERVER_NOT_FOUND=STANZA_ERROR("404","cancel","remote-server-not-found"),ERR_REMOTE_SERVER_TIMEOUT=STANZA_ERROR("504","wait","remote-server-timeout"),ERR_RESOURCE_CONSTRAINT=STANZA_ERROR("500","wait","resource-constraint"),ERR_SERVICE_UNAVAILABLE=STANZA_ERROR("503","cancel","service-unavailable"),ERR_SUBSCRIPTION_REQUIRED=STANZA_ERROR("407","auth","subscription-required"),ERR_UNEXPECTED_REQUEST=STANZA_ERROR("400","wait","unexpected-request");JSJaCCookie.read=function(e){var t=e+"=",n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];while(i.charAt(0)==" ")i=i.substring(1,i.length);if(i.indexOf(t)==0)return new JSJaCCookie(e,JSJaCCookie._unescape(i.substring(t.length,i.length)))}throw new JSJaCCookieException("Cookie not found")},JSJaCCookie.get=function(e){return JSJaCCookie.read(e).getValue()},JSJaCCookie.remove=function(e){JSJaCCookie.read(e).erase()},JSJaCCookie._escape=function(e){return e.replace(/;/g,"%3AB")},JSJaCCookie._unescape=function(e){return e.replace(/%3AB/g,";")};var JSJACJID_FORBIDDEN=['"'," ","&","'","/",":","<",">","@"];JSJaCJID.prototype.getBareJID=function(){return this.getNode()+"@"+this.getDomain()},JSJaCJID.prototype.getNode=function(){return this._node},JSJaCJID.prototype.getDomain=function(){return this._domain},JSJaCJID.prototype.getResource=function(){return this._resource},JSJaCJID.prototype.setNode=function(e){return JSJaCJID._checkNodeName(e),this._node=e||"",this},JSJaCJID.prototype.setDomain=function(e){if(!e||e==="")throw new JSJaCJIDInvalidException("domain name missing");return JSJaCJID._checkNodeName(e),this._domain=e,this},JSJaCJID.prototype.setResource=function(e){return this._resource=e||"",this},JSJaCJID.prototype.toString=function(){var e="";return this.getNode()&&this.getNode()!==""&&(e=this.getNode()+"@"),e+=this.getDomain(),this.getResource()&&this.getResource()!==""&&(e+="/"+this.getResource()),e},JSJaCJID.prototype.removeResource=function(){return this.setResource()},JSJaCJID.prototype.clone=function(){return new JSJaCJID(this.toString())},JSJaCJID.prototype.isEntity=function(e){return typeof e=="string"?e=new JSJaCJID(e):e=e.clone(),e.removeResource(),this.clone().removeResource().toString()===e.toString()},JSJaCJID._checkNodeName=function(e){if(!e||e==="")return;for(var t=0;t<JSJACJID_FORBIDDEN.length;t++)if(e.indexOf(JSJACJID_FORBIDDEN[t])!=-1)throw new JSJaCJIDInvalidException("forbidden char in nodename: "+JSJACJID_FORBIDDEN[t])};var JSJACPACKET_USE_XMLNS=!0;JSJaCPacket.prototype.pType=function(){return this.name},JSJaCPacket.prototype.getDoc=function(){return this.doc},JSJaCPacket.prototype.getNode=function(){return this.getDoc()&&this.getDoc().documentElement?this.getDoc().documentElement:null},JSJaCPacket.prototype.setTo=function(e){return!e||e==""?this.getNode().removeAttribute("to"):typeof e=="string"?this.getNode().setAttribute("to",e):this.getNode().setAttribute("to",e.toString()),this},JSJaCPacket.prototype.setFrom=function(e){return!e||e==""?this.getNode().removeAttribute("from"):typeof e=="string"?this.getNode().setAttribute("from",e):this.getNode().setAttribute("from",e.toString()),this},JSJaCPacket.prototype.setID=function(e){return!e||e==""?this.getNode().removeAttribute("id"):this.getNode().setAttribute("id",e),this},JSJaCPacket.prototype.setType=function(e){return!e||e==""?this.getNode().removeAttribute("type"):this.getNode().setAttribute("type",e),this},JSJaCPacket.prototype.setXMLLang=function(e){return!e||e==""?this.getNode().removeAttribute("xml:lang"):this.getNode().setAttribute("xml:lang",e),this},JSJaCPacket.prototype.getTo=function(){return this.getNode().getAttribute("to")},JSJaCPacket.prototype.getFrom=function(){return this.getNode().getAttribute("from")},JSJaCPacket.prototype.getToJID=function(){return new JSJaCJID(this.getTo())},JSJaCPacket.prototype.getFromJID=function(){return new JSJaCJID(this.getFrom())},JSJaCPacket.prototype.getID=function(){return this.getNode().getAttribute("id")},JSJaCPacket.prototype.getType=function(){return this.getNode().getAttribute("type")},JSJaCPacket.prototype.getXMLLang=function(){return this.getNode().getAttribute("xml:lang")},JSJaCPacket.prototype.getXMLNS=function(){return this.getNode().namespaceURI||this.getNode().getAttribute("xmlns")},JSJaCPacket.prototype.getChild=function(e,t){if(!this.getNode())return null;e=e||"*",t=t||"*";if(this.getNode().getElementsByTagNameNS)return this.getNode().getElementsByTagNameNS(t,e).item(0);var n=this.getNode().getElementsByTagName(e);if(t=="*")return n.item(0);for(var r=0;r<n.length;r++)if(n.item(r).namespaceURI==t||n.item(r).getAttribute("xmlns")==t)return n.item(r);return null},JSJaCPacket.prototype.getChildVal=function(e,t){var n=this.getChild(e,t),r="";if(n&&n.hasChildNodes())for(var i=0;i<n.childNodes.length;i++)n.childNodes.item(i).nodeValue&&(r+=n.childNodes.item(i).nodeValue);return r},JSJaCPacket.prototype.clone=function(){return JSJaCPacket.wrapNode(this.getNode())},JSJaCPacket.prototype.isError=function(){return this.getType()=="error"},JSJaCPacket.prototype.errorReply=function(e){var t=this.clone();return t.setTo(this.getFrom()),t.setFrom(),t.setType("error"),t.appendNode("error",{code:e.code,type:e.type},[[e.cond,{xmlns:NS_STANZAS}]]),t},JSJaCPacket.prototype.xml=typeof XMLSerializer!="undefined"?function(){var e=(new XMLSerializer).serializeToString(this.getNode());return typeof e=="undefined"&&(e=(new XMLSerializer).serializeToString(this.doc)),e}:function(){return this.getDoc().xml},JSJaCPacket.prototype._getAttribute=function(e){return this.getNode().getAttribute(e)},document.ELEMENT_NODE==null&&(document.ELEMENT_NODE=1,document.ATTRIBUTE_NODE=2,document.TEXT_NODE=3,document.CDATA_SECTION_NODE=4,document.ENTITY_REFERENCE_NODE=5,document.ENTITY_NODE=6,document.PROCESSING_INSTRUCTION_NODE=7,document.COMMENT_NODE=8,document.DOCUMENT_NODE=9,document.DOCUMENT_TYPE_NODE=10,document.DOCUMENT_FRAGMENT_NODE=11,document.NOTATION_NODE=12),JSJaCPacket.prototype._importNode=function(e,t){switch(e.nodeType){case document.ELEMENT_NODE:var n;this.getDoc().createElementNS?n=this.getDoc().createElementNS(e.namespaceURI,e.nodeName):n=this.getDoc().createElement(e.nodeName);var r,i;if(e.attributes&&e.attributes.length>0)for(r=0,i=e.attributes.length;r<i;r++){var s=e.attributes.item(r);if(!(s.nodeName!="xmlns"||n.getAttribute("xmlns")===null&&!n.namespaceURI))continue;n.setAttributeNS&&s.namespaceURI?n.setAttributeNS(s.namespaceURI,s.name,s.value):n.setAttribute(s.name,s.value)}if(t&&e.childNodes&&e.childNodes.length>0)for(r=0,i=e.childNodes.length;r<i;r++)n.appendChild(this._importNode(e.childNodes.item(r),t));return n;case document.TEXT_NODE:case document.CDATA_SECTION_NODE:case document.COMMENT_NODE:return this.getDoc().createTextNode(e.nodeValue)}},JSJaCPacket.prototype._setChildNode=function(e,t){var n=this.getChild(e),r=this.getDoc().createTextNode(t);if(n)try{n.replaceChild(r,n.firstChild)}catch(i){}else{try{n=this.getDoc().createElementNS(this.getNode().namespaceURI,e)}catch(s){n=this.getDoc().createElement(e)}this.getNode().appendChild(n),n.appendChild(r)}return n},JSJaCPacket.prototype.buildNode=function(e){return JSJaCBuilder.buildNode(this.getDoc(),e,arguments[1],arguments[2],arguments[3])},JSJaCPacket.prototype.appendNode=function(e){return typeof e=="object"?this.getNode().appendChild(e):this.getNode().appendChild(this.buildNode(e,arguments[1],arguments[2],this.getNode().namespaceURI)),this},JSJaCPresence.prototype=new JSJaCPacket,JSJaCPresence.prototype.setStatus=function(e){return this._setChildNode("status",e),this},JSJaCPresence.prototype.setShow=function(e){return(e=="chat"||e=="away"||e=="xa"||e=="dnd")&&this._setChildNode("show",e),this},JSJaCPresence.prototype.setPriority=function(e){return this._setChildNode("priority",e),this},JSJaCPresence.prototype.setPresence=function(e,t,n){return e&&this.setShow(e),t&&this.setStatus(t),n&&this.setPriority(n),this},JSJaCPresence.prototype.getStatus=function(){return this.getChildVal("status")},JSJaCPresence.prototype.getShow=function(){return this.getChildVal("show")},JSJaCPresence.prototype.getPriority=function(){return this.getChildVal("priority")},JSJaCIQ.prototype=new JSJaCPacket,JSJaCIQ.prototype.setIQ=function(e,t,n){return e&&this.setTo(e),t&&this.setType(t),n&&this.setID(n),this},JSJaCIQ.prototype.setQuery=function(e){var t;try{t=this.getDoc().createElementNS(e,"query")}catch(n){t=this.getDoc().createElement("query"),t.setAttribute("xmlns",e)}return this.getNode().appendChild(t),t},JSJaCIQ.prototype.getQuery=function(){return this.getNode().getElementsByTagName("query").item(0)},JSJaCIQ.prototype.getQueryXMLNS=function(){return this.getQuery()?this.getQuery().namespaceURI||this.getQuery().getAttribute("xmlns"):null},JSJaCIQ.prototype.reply=function(e){var t=this.clone();t.setTo(this.getFrom()),t.setFrom(),t.setType("result");if(e)if(typeof e=="string")t.getChild().appendChild(t.getDoc().loadXML(e));else if(e.constructor==Array){var n=t.getChild();for(var r=0;r<e.length;r++)typeof e[r]=="string"?n.appendChild(t.getDoc().loadXML(e[r])):typeof e[r]=="object"&&n.appendChild(e[r])}else typeof e=="object"&&t.getChild().appendChild(e);return t},JSJaCMessage.prototype=new JSJaCPacket,JSJaCMessage.prototype.setBody=function(e){return this._setChildNode("body",e),this},JSJaCMessage.prototype.setSubject=function(e){return this._setChildNode("subject",e),this},JSJaCMessage.prototype.setThread=function(e){return this._setChildNode("thread",e),this},JSJaCMessage.prototype.getThread=function(){return this.getChildVal("thread")},JSJaCMessage.prototype.getBody=function(){return this.getChildVal("body")},JSJaCMessage.prototype.getSubject=function(){return this.getChildVal("subject")},JSJaCPacket.wrapNode=function(e){var t=null;switch(e.nodeName.toLowerCase()){case"presence":t=new JSJaCPresence;break;case"message":t=new JSJaCMessage;break;case"iq":t=new JSJaCIQ}return t&&t.getDoc().replaceChild(t._importNode(e,!0),t.getNode()),t},JSJaCConnection.prototype.connect=function(e){this._setStatus("connecting");if(e.authtype!="x-facebook-platform")this.domain=e.domain||"localhost",this.username=e.username,this.resource=e.resource,this.pass=e.password||e.pass,this.register=e.register,this.authhost=e.authhost||e.host||e.domain,this.authtype=e.authtype||"sasl";else{this.domain="chat.facebook.com",this.authtype=e.authtype;if(e.facebookApp===undefined){this.oDbg.log("No Facebook application param specified!",1);return}this._facebookApp=e.facebookApp;if(!document.getElementById("fb-root")){var t=document.createElement("div");t.id="fb-root",document.body.appendChild(t)}if(e.facebookApp.getSession()===undefined){this._facebookApp.Login(this,e);return}}e.xmllang&&e.xmllang!==""?this._xmllang=e.xmllang:this._xmllang="en",e.allow_plain?this._allow_plain=e.allow_plain:this._allow_plain=JSJAC_ALLOW_PLAIN,this.host=e.host,this.port=e.port||5222,e.secure?this.secure="true":this.secure="false",this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,this._rid=Math.round(100000.5+799999.99999*Math.random());var n=this._getFreeSlot();this._req[n]=this._setupRequest(!0);var r=this._getInitialRequestString();this.oDbg.log(r,4),this._req[n].r.onreadystatechange=JSJaC.bind(function(){var e=this._req[n].r;e.readyState==4&&(this.oDbg.log("async recv: "+e.responseText,4),this._handleInitialResponse(e))},this),typeof this._req[n].r.onerror!="undefined"&&(this._req[n].r.onerror=JSJaC.bind(function(e){this.oDbg.log("XmlHttpRequest error",1)},this)),this._req[n].r.send(r)},JSJaCConnection.prototype.connected=function(){return this._connected},JSJaCConnection.prototype.disconnect=function(){this._setStatus("disconnecting");if(!this.connected())return;this._connected=!1,clearInterval(this._interval),clearInterval(this._inQto),this._timeout&&clearTimeout(this._timeout);var e=this._getFreeSlot();this._req[e]=this._setupRequest(!1);var t=this._getRequestString(!1,!0);this.oDbg.log("Disconnecting: "+t,4);try{this._req[e].r.send(t)}catch(n){}this.oDbg.log("disconnected");try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(n){}this._handleEvent("ondisconnect")},JSJaCConnection.prototype.getPollInterval=function(){return this._timerval},JSJaCConnection.prototype.registerHandler=function(event){event=event.toLowerCase();var eArg={handler:arguments[arguments.length-1],childName:"*",childNS:"*",type:"*"};arguments.length>2&&(eArg.childName=arguments[1]),arguments.length>3&&(eArg.childNS=arguments[2]),arguments.length>4&&(eArg.type=arguments[3]),this._events[event]?this._events[event]=this._events[event].concat(eArg):this._events[event]=new Array(eArg),this._events[event]=this._events[event].sort(function(a,b){var aRank=0,bRank=0;with(a)type=="*"&&aRank++,childNS=="*"&&aRank++,childName=="*"&&aRank++;with(b)type=="*"&&bRank++,childNS=="*"&&bRank++,childName=="*"&&bRank++;return aRank>bRank?1:aRank<bRank?-1:0}),this.oDbg.log("registered handler for event '"+event+"'",2)},JSJaCConnection.prototype.unregisterHandler=function(e,t){e=e.toLowerCase();if(!this._events[e])return;var n=this._events[e],r=[];for(var i=0;i<n.length;i++)n[i].handler!=t&&r.push(n[i]);n.length!=r.length&&(this._events[e]=r,this.oDbg.log("unregistered handler for event '"+e+"'",2))},JSJaCConnection.prototype.registerIQGet=function(e,t,n){this.registerHandler("iq",e,t,"get",n)},JSJaCConnection.prototype.registerIQSet=function(e,t,n){this.registerHandler("iq",e,t,"set",n)},JSJaCConnection.prototype.resume=function(){try{var e=JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").getValue();return this.oDbg.log("read cookie: "+e,2),JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase(),this.resumeFromData(JSJaCJSON.parse(e))}catch(t){}return!1},JSJaCConnection.prototype.resumeFromData=function(e){try{this._setStatus("resuming");for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);if(this._keys){this._keys2=new JSJaCKeys;var n=this._keys2._getSuspendVars();for(var r=0;r<n.length;r++)this._keys2[n[r]]=this._keys[n[r]];this._keys=this._keys2}return this._connected&&(this._handleEvent("onresume"),setTimeout(JSJaC.bind(this._resume,this),this.getPollInterval()),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL)),this._connected===!0}catch(i){return i.message?this.oDbg.log("Resume failed: "+i.message,1):this.oDbg.log("Resume failed: "+i,1),!1}},JSJaCConnection.prototype.send=function(e,t,n){return!e||!e.pType?(this.oDbg.log("no packet: "+e,1),!1):this.connected()?(t&&(e.getID()||e.setID("JSJaCID_"+this._ID++),this._registerPID(e.getID(),t,n)),this._pQueue=this._pQueue.concat(e.xml()),this._handleEvent(e.pType()+"_out",e),this._handleEvent("packet_out",e),!0):!1},JSJaCConnection.prototype.sendIQ=function(e,t,n){if(!e||e.pType()!="iq")return!1;t=t||{};var r=t.error_handler||JSJaC.bind(function(e){this.oDbg.log(e.xml(),1)},this),i=t.result_handler||JSJaC.bind(function(e){this.oDbg.log(e.xml(),2)},this),s=function(e,t){switch(e.getType()){case"error":r(e);break;case"result":i(e,t)}};return this.send(e,s,n)},JSJaCConnection.prototype.setPollInterval=function(e){return e&&!isNaN(e)&&(this._timerval=e),this._timerval},JSJaCConnection.prototype.status=function(){return this._status},JSJaCConnection.prototype.suspend=function(){var e=this.suspendToData();try{var t=new JSJaCCookie(this._cookie_prefix+"JSJaC_State",JSJaCJSON.toString(e));this.oDbg.log("writing cookie: "+t.getValue()+"\n"+"(length:"+t.getValue().length+")",2),t.write();var n=JSJaCCookie.get(this._cookie_prefix+"JSJaC_State");return t.getValue()!=n?(this.oDbg.log("Suspend failed writing cookie.\nread: "+n,1),t.erase(),!1):!0}catch(r){this.oDbg.log("Failed creating cookie '"+this._cookie_prefix+"JSJaC_State': "+r.message,1)}return!1},JSJaCConnection.prototype.suspendToData=function(){clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._suspend();var e="_connected,_keys,_ID,_xmllang,_inQ,_pQueue,_regIDs,_errcnt,_inactivity,domain,username,resource,jid,fulljid,_sid,_httpbase,_timerval,_is_polling".split(",");e=e.concat(this._getSuspendVars());var t={};for(var n=0;n<e.length;n++){if(!this[e[n]])continue;var r={};if(this[e[n]]._getSuspendVars){var i=this[e[n]]._getSuspendVars();for(var s=0;s<i.length;s++)r[i[s]]=this[e[n]][i[s]]}else r=this[e[n]];t[e[n]]=r}return this._connected=!1,this._setStatus("suspending"),t},JSJaCConnection.prototype._abort=function(){clearTimeout(this._timeout),clearInterval(this._inQto),clearInterval(this._interval),this._connected=!1,this._setStatus("aborted"),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("500","cancel","service-unavailable"))},JSJaCConnection.prototype._checkInQ=function(){for(var e=0;e<this._inQ.length&&e<10;e++){var t=this._inQ[0];this._inQ=this._inQ.slice(1,this._inQ.length);var n=JSJaCPacket.wrapNode(t);if(!n)return;this._handleEvent("packet_in",n),n.pType&&!this._handlePID(n)&&(this._handleEvent(n.pType()+"_in",n),this._handleEvent(n.pType(),n))}},JSJaCConnection.prototype._checkQueue=function(){return this._pQueue.length>0&&this._process(),!0},JSJaCConnection.prototype._doAuth=function(){return this.has_sasl&&this.authtype=="nonsasl"&&this.oDbg.log("Warning: SASL present but not used",1),!this._doSASLAuth()&&!this._doLegacyAuth()?(this.oDbg.log("Auth failed for authtype "+this.authtype,1),this.disconnect(),!1):!0},JSJaCConnection.prototype._doInBandReg=function(){if(this.authtype=="saslanon"||this.authtype=="anonymous")return;var e=new JSJaCIQ;e.setType("set"),e.setID("reg1"),e.appendNode("query",{xmlns:NS_REGISTER},[["username",this.username],["password",this.pass]]),this.send(e,this._doInBandRegDone)},JSJaCConnection.prototype._doInBandRegDone=function(e){if(e&&e.getType()=="error"){this.oDbg.log("registration failed for "+this.username,0),this._handleEvent("onerror",e.getChild("error"));return}this.oDbg.log(this.username+" registered succesfully",0),this._doAuth()},JSJaCConnection.prototype._doLegacyAuth=function(){if(this.authtype!="nonsasl"&&this.authtype!="anonymous")return!1;var e=new JSJaCIQ;return e.setIQ(null,"get","auth1"),e.appendNode("query",{xmlns:NS_AUTH},[["username",this.username]]),this.send(e,this._doLegacyAuth2),!0},JSJaCConnection.prototype._doLegacyAuth2=function(e){if(!e||e.getType()!="result"){e&&e.getType()=="error"&&this._handleEvent("onerror",e.getChild("error")),this.disconnect();return}var t=e.getChild("digest")!==null,n=new JSJaCIQ;n.setIQ(null,"set","auth2");var r=n.appendNode("query",{xmlns:NS_AUTH},[["username",this.username],["resource",this.resource]]);if(t)r.appendChild(n.buildNode("digest",{xmlns:NS_AUTH},hex_sha1(this.streamid+this.pass)));else{if(!this._allow_plain){this.oDbg.log("no valid login mechanism found",1),this.disconnect();return}r.appendChild(n.buildNode("password",{xmlns:NS_AUTH},this.pass))}this.send(n,this._doLegacyAuthDone)},JSJaCConnection.prototype._doLegacyAuthDone=function(e){e.getType()!="result"?(e.getType()=="error"&&this._handleEvent("onerror",e.getChild("error")),this.disconnect()):this._handleEvent("onconnect")},JSJaCConnection.prototype._doSASLAuth=function(){if(this.authtype=="nonsasl"||this.authtype=="anonymous")return!1;if(this.authtype=="saslanon"){if(this.mechs.ANONYMOUS)return this.oDbg.log("SASL using mechanism 'ANONYMOUS'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='ANONYMOUS'/>",this._doSASLAuthDone);this.oDbg.log("SASL ANONYMOUS requested but not supported",1)}else if(this.authtype=="x-facebook-platform"){if(this.mechs["X-FACEBOOK-PLATFORM"])return this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='X-FACEBOOK-PLATFORM' />",this._doFacebookAuth);this.oDbg.log("X-FACEBOOK-PLATFORM requested but not supported",1)}else{if(this.mechs["DIGEST-MD5"])return this.oDbg.log("SASL using mechanism 'DIGEST-MD5'",2),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='DIGEST-MD5'/>",this._doSASLAuthDigestMd5S1);if(this._allow_plain&&this.mechs.PLAIN){this.oDbg.log("SASL using mechanism 'PLAIN'",2);var e=this.username+"@"+this.domain+String.fromCharCode(0)+this.username+String.fromCharCode(0)+this.pass;return this.oDbg.log("authenticating with '"+e+"'",2),e=b64encode(e),this._sendRaw("<auth xmlns='urn:ietf:params:xml:ns:xmpp-sasl' mechanism='PLAIN'>"+e+"</auth>",this._doSASLAuthDone)}this.oDbg.log("No SASL mechanism applied",1),this.authtype="nonsasl"}return!1},JSJaCConnection.prototype._doSASLAuthDigestMd5S1=function(e){if(e.nodeName!="challenge")this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var t=b64decode(e.firstChild.nodeValue);this.oDbg.log("got challenge: "+t,2),this._nonce=t.substring(t.indexOf("nonce=")+7),this._nonce=this._nonce.substring(0,this._nonce.indexOf('"')),this.oDbg.log("nonce: "+this._nonce,2);if(this._nonce===""||this._nonce.indexOf('"')!=-1){this.oDbg.log("nonce not valid, aborting",1),this.disconnect();return}this._digest_uri="xmpp/",this._digest_uri+=this.domain,this._cnonce=cnonce(14),this._nc="00000001";var n=str_md5(this.username+":"+this.domain+":"+this.pass)+":"+this._nonce+":"+this._cnonce,r="AUTHENTICATE:"+this._digest_uri,i=hex_md5(hex_md5(n)+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+hex_md5(r)),s='username="'+this.username+'",realm="'+this.domain+'",nonce="'+this._nonce+'",cnonce="'+this._cnonce+'",nc="'+this._nc+'",qop=auth,digest-uri="'+this._digest_uri+'",response="'+i+'",charset="utf-8"';this.oDbg.log("response: "+s,2),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+binb2b64(str2binb(s))+"</response>",this._doSASLAuthDigestMd5S2)}},JSJaCConnection.prototype._doSASLAuthDigestMd5S2=function(e){if(e.nodeName=="failure"){e.xml?this.oDbg.log("auth error: "+e.xml,1):this.oDbg.log("auth error",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();return}var t=b64decode(e.firstChild.nodeValue);this.oDbg.log("response: "+t,2);var n=t.substring(t.indexOf("rspauth=")+8);this.oDbg.log("rspauth: "+n,2);var r=str_md5(this.username+":"+this.domain+":"+this.pass)+":"+this._nonce+":"+this._cnonce,i=":"+this._digest_uri,s=hex_md5(hex_md5(r)+":"+this._nonce+":"+this._nc+":"+this._cnonce+":auth:"+hex_md5(i));this.oDbg.log("rsptest: "+s,2);if(s!=n){this.oDbg.log("SASL Digest-MD5: server repsonse with wrong rspauth",1),this.disconnect();return}e.nodeName=="success"?this._reInitStream(JSJaC.bind(this._doStreamBind,this)):this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'/>",this._doSASLAuthDone)},JSJaCConnection.prototype._doSASLAuthDone=function(e){e.nodeName!="success"?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))},JSJaCConnection.prototype._doFacebookAuth=function(e){if(e.nodeName!="challenge")this.oDbg.log("challenge missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect();else{var t=b64decode(e.firstChild.nodeValue);this.oDbg.log("got challenge: "+t,2);var n=t.split("&"),r=Array();for(var i=0;i<n.length;i++){var s=n[i].split("=");r[s[0]]=s[1]}if(r["nonce"]!=""){var o=this._facebookApp.getSession(),u={api_key:this._facebookApp.getApiKey(),call_id:(new Date).getTime(),method:r.method,nonce:r.nonce,session_key:o.session_key,v:"1.0"};return u.sig="api_key="+u.api_key+"call_id="+u.call_id+"method="+u.method+"nonce="+u.nonce+"session_key="+u.session_key+"v="+u.v,u.sig=hex_md5(u.sig+this._facebookApp.getApiSecret()),u="api_key="+u.api_key+"&"+"call_id="+u.call_id+"&"+"method="+u.method+"&"+"nonce="+u.nonce+"&"+"session_key="+u.session_key+"&"+"v="+u.v+"&"+"sig="+u.sig,u=b64encode(u),this._sendRaw("<response xmlns='urn:ietf:params:xml:ns:xmpp-sasl'>"+u+"</response>",this._doFacebookAuthDone)}this.oDbg.log("nonce missing",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()}},JSJaCConnection.prototype._doFacebookAuthDone=function(e){e.nodeName!="success"?(this.oDbg.log("auth failed",1),this._handleEvent("onerror",JSJaCError("401","auth","not-authorized")),this.disconnect()):this._reInitStream(JSJaC.bind(this._doStreamBind,this))},JSJaCConnection.prototype._doStreamBind=function(){var e=new JSJaCIQ;e.setIQ(null,"set","bind_1"),e.appendNode("bind",{xmlns:NS_BIND},[["resource",this.resource]]),this.oDbg.log(e.xml()),this.send(e,this._doXMPPSess)},JSJaCConnection.prototype._doXMPPSess=function(e){if(e.getType()!="result"||e.getType()=="error"){this.disconnect(),e.getType()=="error"&&this._handleEvent("onerror",e.getChild("error"));return}this.fulljid=e.getChildVal("jid"),this.jid=this.fulljid.substring(0,this.fulljid.lastIndexOf("/")),e=new JSJaCIQ,e.setIQ(null,"set","sess_1"),e.appendNode("session",{xmlns:NS_SESSION},[]),this.oDbg.log(e.xml()),this.send(e,this._doXMPPSessDone)},JSJaCConnection.prototype._doXMPPSessDone=function(e){if(e.getType()!="result"||e.getType()=="error"){this.disconnect(),e.getType()=="error"&&this._handleEvent("onerror",e.getChild("error"));return}this._handleEvent("onconnect")},JSJaCConnection.prototype._handleEvent=function(e,t){e=e.toLowerCase(),this.oDbg.log("incoming event '"+e+"'",3);if(!this._events[e])return;this.oDbg.log("handling event '"+e+"'",2);for(var n=0;n<this._events[e].length;n++){var r=this._events[e][n];if(typeof r.handler=="function")if(t){if(t.pType){if(!t.getNode().hasChildNodes()&&r.childName!="*"||t.getNode().hasChildNodes()&&!t.getChild(r.childName,r.childNS))continue;if(r.type!="*"&&t.getType()!=r.type)continue;this.oDbg.log(r.childName+"/"+r.childNS+"/"+r.type+" => match for handler "+r.handler,3)}if(r.handler(t))break}else if(r.handler())break}},JSJaCConnection.prototype._handlePID=function(e){if(!e.getID())return!1;for(var t in this._regIDs)if(this._regIDs.hasOwnProperty(t)&&this._regIDs[t]&&t==e.getID()){var n=e.getID();return this.oDbg.log("handling "+n,3),this._regIDs[t].cb.call(this,e,this._regIDs[t].arg)===!1?!1:(this._unregisterPID(n),!0)}return!1},JSJaCConnection.prototype._handleResponse=function(e){var t=this._parseResponse(e);if(!t)return;for(var n=0;n<t.childNodes.length;n++){if(this._sendRawCallbacks.length){var r=this._sendRawCallbacks[0];this._sendRawCallbacks=this._sendRawCallbacks.slice(1,this._sendRawCallbacks.length),r.fn.call(this,t.childNodes.item(n),r.arg);continue}this._inQ=this._inQ.concat(t.childNodes.item(n))}},JSJaCConnection.prototype._parseStreamFeatures=function(e){if(!e)return this.oDbg.log("nothing to parse ... aborting",1),!1;var t;if(e.getElementsByTagNameNS)t=e.getElementsByTagNameNS(NS_STREAM,"error").item(0);else{var n=e.getElementsByTagName("error");for(var r=0;r<n.length;r++)if(n.item(r).namespaceURI==NS_STREAM||n.item(r).getAttribute("xmlns")==NS_STREAM){t=n.item(r);break}}if(t)return this._setStatus("internal_server_error"),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._handleEvent("onerror",JSJaCError("503","cancel","session-terminate")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),!1;this.mechs={};var i=e.getElementsByTagName("mechanisms");if(!i.length)return!1;this.has_sasl=!1;for(var r=0;r<i.length;r++)if(i.item(r).getAttribute("xmlns")==NS_SASL){this.has_sasl=!0;var s=i.item(r).getElementsByTagName("mechanism");for(var o=0;o<s.length;o++)this.mechs[s.item(o).firstChild.nodeValue]=!0;break}return this.has_sasl?(this.oDbg.log("SASL detected",2),!0):(this.oDbg.log("No support for SASL detected",2),!0)},JSJaCConnection.prototype._process=function(e){if(!this.connected()){this.oDbg.log("Connection lost ...",1),this._interval&&clearInterval(this._interval);return}this.setPollInterval(e),this._timeout&&clearTimeout(this._timeout);var t=this._getFreeSlot();if(t<0)return;if(typeof this._req[t]!="undefined"&&typeof this._req[t].r!="undefined"&&this._req[t].r.readyState!=4){this.oDbg.log("Slot "+t+" is not ready");return}if(!this.isPolling()&&this._pQueue.length===0&&this._req[(t+1)%2]&&this._req[(t+1)%2].r.readyState!=4){this.oDbg.log("all slots busy, standby ...",2);return}this.isPolling()||this.oDbg.log("Found working slot at "+t,2),this._req[t]=this._setupRequest(!0),this._req[t].r.onreadystatechange=JSJaC.bind(function(){if(!this.connected())return;this._req[t].r.readyState==4&&(this.oDbg.log("async recv: "+this._req[t].r.responseText,4),this._handleResponse(this._req[t]),this._setStatus("processing"),this._pQueue.length?this._timeout=setTimeout(JSJaC.bind(this._process,this),100):(this.oDbg.log("scheduling next poll in "+this.getPollInterval()+" msec",4),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())))},this);try{this._req[t].r.onerror=JSJaC.bind(function(){if(!this.connected())return;this._errcnt++,this.oDbg.log("XmlHttpRequest error ("+this._errcnt+")",1);if(this._errcnt>JSJAC_ERR_COUNT){this._abort();return}this._setStatus("onerror_fallback"),setTimeout(JSJaC.bind(this._repeat,this),JSJAC_RETRYDELAY);return},this)}catch(n){}var r=this._getRequestString();typeof this._rid!="undefined"&&(this._req[t].rid=this._rid),this.oDbg.log("sending: "+r,4),this._req[t].r.send(r)},JSJaCConnection.prototype._registerPID=function(e,t,n){return!e||!t?!1:(this._regIDs[e]={},this._regIDs[e].cb=t,n&&(this._regIDs[e].arg=n),this.oDbg.log("registered "+e,3),!0)},JSJaCConnection.prototype._prepSendEmpty=function(e,t){return function(){t._sendEmpty(JSJaC.bind(e,t))}},JSJaCConnection.prototype._sendEmpty=function(e){var t=this._getFreeSlot();this._req[t]=this._setupRequest(!0),this._req[t].r.onreadystatechange=JSJaC.bind(function(){this._req[t].r.readyState==4&&(this.oDbg.log("async recv: "+this._req[t].r.responseText,4),e(this._req[t].r))},this),typeof this._req[t].r.onerror!="undefined"&&(this._req[t].r.onerror=JSJaC.bind(function(e){this.oDbg.log("XmlHttpRequest error",1)},this));var n=this._getRequestString();this.oDbg.log("sending: "+n,4),this._req[t].r.send(n)},JSJaCConnection.prototype._sendRaw=function(e,t,n){return t&&this._sendRawCallbacks.push({fn:t,arg:n}),this._pQueue.push(e),this._process(),!0},JSJaCConnection.prototype._setStatus=function(e){if(!e||e==="")return;e!=this._status&&(this._status=e,this._handleEvent("onstatuschanged",e),this._handleEvent("status_changed",e))},JSJaCConnection.prototype._unregisterPID=function(e){return this._regIDs[e]?(this._regIDs[e]=null,this.oDbg.log("unregistered "+e,3),!0):!1},JSJaCHttpBindingConnection.prototype=new JSJaCConnection,JSJaCHttpBindingConnection.prototype.inherit=function(e){if(e.jid){var t=new JSJaCJID(e.jid);this.domain=t.getDomain(),this.username=t.getNode(),this.resource=t.getResource()}else this.domain=e.domain||"localhost",this.username=e.username,this.resource=e.resource;this._sid=e.sid,this._rid=e.rid,this._min_polling=e.polling,this._inactivity=e.inactivity,this._setHold(e.requests-1),this.setPollInterval(this._timerval),e.wait&&(this._wait=e.wait),this._connected=!0,this._handleEvent("onconnect"),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval())},JSJaCHttpBindingConnection.prototype.setPollInterval=function(e){return e&&!isNaN(e)&&(this.isPolling()?this._min_polling&&e<this._min_polling*1e3?this._timerval=this._min_polling*1e3:this._inactivity&&e>this._inactivity*1e3?this._timerval=this._inactivity*1e3:this._timerval=e:this._timerval=100),this._timerval},JSJaCHttpBindingConnection.prototype.isPolling=function(){return this._hold===0},JSJaCHttpBindingConnection.prototype._getFreeSlot=function(){for(var e=0;e<this._hold+1;e++)if(typeof this._req[e]=="undefined"||typeof this._req[e].r=="undefined"||this._req[e].r.readyState==4)return e;return-1},JSJaCHttpBindingConnection.prototype._getHold=function(){return this._hold},JSJaCHttpBindingConnection.prototype._getRequestString=function(e,t){e=e||"";var n="";if(this._rid<=this._last_rid&&typeof this._last_requests[this._rid]!="undefined")n=this._last_requests[this._rid].xml;else{var r="";while(this._pQueue.length){var i=this._pQueue[0];r+=i,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}n="<body rid='"+this._rid+"' sid='"+this._sid+"' xmlns='http://jabber.org/protocol/httpbind' ",JSJAC_HAVEKEYS&&(n+="key='"+this._keys.getKey()+"' ",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),n+="newkey='"+this._keys.getKey()+"' ")),t?n+="type='terminate'":this._reinit&&(JSJACHBC_USE_BOSH_VER&&(n+="xml:lang='"+this._xmllang+"' xmpp:restart='true' xmlns:xmpp='urn:xmpp:xbosh' to='"+this.domain+"'"),this._reinit=!1),r!=""||e!=""?n+=">"+e+r+"</body>":n+="> </body>",this._last_requests[this._rid]={},this._last_requests[this._rid].xml=n,this._last_rid=this._rid;for(var s in this._last_requests)this._last_requests.hasOwnProperty(s)&&s<this._rid-this._hold&&delete this._last_requests[s]}return n},JSJaCHttpBindingConnection.prototype._getInitialRequestString=function(){var e="<body content='text/xml; charset=utf-8' hold='"+this._hold+"' xmlns='http://jabber.org/protocol/httpbind' to='"+this.authhost+"' wait='"+this._wait+"' rid='"+this._rid+"'";this.host&&this.port&&(e+=" route='xmpp:"+this.host+":"+this.port+"'"),this.secure&&(e+=" secure='"+this.secure+"'");if(JSJAC_HAVEKEYS){this._keys=new JSJaCKeys(hex_sha1,this.oDbg);var t=this._keys.getKey();e+=" newkey='"+t+"'"}e+=" xml:lang='"+this._xmllang+"'";if(JSJACHBC_USE_BOSH_VER){e+=" ver='"+JSJACHBC_BOSH_VERSION+"'",e+=" xmlns:xmpp='urn:xmpp:xbosh'";if(this.authtype=="sasl"||this.authtype=="saslanon"||this.authtype=="x-facebook-platform")e+=" xmpp:version='1.0'"}return e+="/>",e},JSJaCHttpBindingConnection.prototype._getStreamID=function(e){this.oDbg.log(e.responseText,4);if(!e.responseXML||!e.responseXML.documentElement){this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));return}var t=e.responseXML.documentElement;if(t.getAttribute("type")=="terminate"){this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));return}t.getAttribute("authid")&&(this.streamid=t.getAttribute("authid"),this.oDbg.log("got streamid: "+this.streamid,2));if(!this._parseStreamFeatures(t)){this._sendEmpty(JSJaC.bind(this._getStreamID,this));return}this._timeout=setTimeout(JSJaC.bind(this._process,this),this.getPollInterval()),this.register?this._doInBandReg():this._doAuth()},JSJaCHttpBindingConnection.prototype._getSuspendVars=function(){return"host,port,secure,_rid,_last_rid,_wait,_min_polling,_inactivity,_hold,_last_requests,_pause".split(",")},JSJaCHttpBindingConnection.prototype._handleInitialResponse=function(e){try{this.oDbg.log(e.getAllResponseHeaders(),4),this.oDbg.log(e.responseText,4)}catch(t){this.oDbg.log("No response",4)}if(e.status!=200||!e.responseXML){this.oDbg.log("initial response broken (status: "+e.status+")",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));return}var n=e.responseXML.documentElement;if(!n||n.tagName!="body"||n.namespaceURI!=NS_BOSH){this.oDbg.log("no body element or incorrect body in initial response",1),this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"));return}if(n.getAttribute("type")=="terminate"){this.oDbg.log("invalid response:\n"+e.responseText,1),clearTimeout(this._timeout),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));return}this._sid=n.getAttribute("sid"),this.oDbg.log("got sid: "+this._sid,2),n.getAttribute("polling")&&(this._min_polling=n.getAttribute("polling")),n.getAttribute("inactivity")&&(this._inactivity=n.getAttribute("inactivity")),n.getAttribute("requests")&&this._setHold(n.getAttribute("requests")-1),this.oDbg.log("set hold to "+this._getHold(),2),n.getAttribute("ver")&&(this._bosh_version=n.getAttribute("ver")),n.getAttribute("maxpause")&&(this._pause=Number.min(n.getAttribute("maxpause"),JSJACHBC_MAXPAUSE)),this.setPollInterval(this._timerval),this._connected=!0,this._inQto=setInterval(JSJaC.bind(this._checkInQ,this),JSJAC_CHECKINQUEUEINTERVAL),this._interval=setInterval(JSJaC.bind(this._checkQueue,this),JSJAC_CHECKQUEUEINTERVAL),this._getStreamID(e)},JSJaCHttpBindingConnection.prototype._parseResponse=function(e){if(!this.connected()||!e)return null;var t=e.r;try{if(t.status==404||t.status==403)return this._abort(),null;if(t.status!=200||!t.responseXML){this._errcnt++;var n="invalid response ("+t.status+"):\n"+t.getAllResponseHeaders()+"\n"+t.responseText;return t.responseXML||(n+="\nResponse failed to parse!"),this.oDbg.log(n,1),this._errcnt>JSJAC_ERR_COUNT?(this._abort(),null):(this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null)}}catch(r){return this.oDbg.log("XMLHttpRequest error: status not available",1),this._errcnt++,this._errcnt>JSJAC_ERR_COUNT?this._abort():this.connected()&&(this.oDbg.log("repeating ("+this._errcnt+")",1),this._setStatus("proto_error_fallback"),setTimeout(JSJaC.bind(this._repeat,this),this.getPollInterval())),null}var i=t.responseXML.documentElement;if(!i||i.tagName!="body"||i.namespaceURI!=NS_BOSH)return this.oDbg.log("invalid response:\n"+t.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),this._setStatus("internal_server_error"),this._handleEvent("onerror",JSJaCError("500","wait","internal-server-error")),null;if(typeof e.rid!="undefined"&&this._last_requests[e.rid]){if(this._last_requests[e.rid].handled)return this.oDbg.log("already handled "+e.rid,2),null;this._last_requests[e.rid].handled=!0}if(i.getAttribute("type")=="terminate"){var s=i.getAttribute("condition");this.oDbg.log("session terminated:\n"+t.responseText,1),clearTimeout(this._timeout),clearInterval(this._interval),clearInterval(this._inQto);try{JSJaCCookie.read(this._cookie_prefix+"JSJaC_State").erase()}catch(r){}this._connected=!1,s=="remote-stream-error"?i.getElementsByTagName("conflict").length>0?this._setStatus("session-terminate-conflict"):this._setStatus("terminated"):this._setStatus("terminated"),s===null&&(s="session-terminate"),this._handleEvent("onerror",JSJaCError("503","cancel",s)),this.oDbg.log("Aborting remaining connections",4);for(var o=0;o<this._hold+1;o++)try{this._req[o]&&this._req[o]!=e&&this._req[o].r.abort()}catch(r){this.oDbg.log(r,1)}return this.oDbg.log("parseResponse done with terminating",3),this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect"),null}return this._errcnt=0,t.responseXML.documentElement},JSJaCHttpBindingConnection.prototype._reInitStream=function(e){this._reinit=!0,this._sendEmpty(this._prepReInitStreamWait(e))},JSJaCHttpBindingConnection.prototype._prepReInitStreamWait=function(e){return JSJaC.bind(function(t){this._reInitStreamWait(t,e)},this)},JSJaCHttpBindingConnection.prototype._reInitStreamWait=function(e,t){this.oDbg.log("checking for stream features");var n=e.responseXML.documentElement,r,i;this.oDbg.log(n);if(n.getElementsByTagNameNS)this.oDbg.log("checking with namespace"),r=n.getElementsByTagNameNS(NS_STREAM,"features").item(0),r&&(i=r.getElementsByTagNameNS(NS_BIND,"bind").item(0));else{var s=n.getElementsByTagName("stream:features"),o,u;for(o=0,u=s.length;o<u;o++)if(s.item(o).namespaceURI==NS_STREAM||s.item(o).getAttribute("xmlns")==NS_STREAM){r=s.item(o);break}if(r){i=r.getElementsByTagName("bind");for(o=0,u=i.length;o<u;o++)if(i.item(o).namespaceURI==NS_BIND||i.item(o).getAttribute("xmlns")==NS_BIND){i=i.item(o);break}}}this.oDbg.log(r),this.oDbg.log(i),r?i?t():(this.oDbg.log("no bind feature - giving up",1),this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")),this._connected=!1,this.oDbg.log("Disconnected.",1),this._handleEvent("ondisconnect")):this._sendEmpty(this._prepReInitStreamWait(t))},JSJaCHttpBindingConnection.prototype._repeat=function(){this._rid>=this._last_rid&&(this._rid=this._last_rid-1),this._process()},JSJaCHttpBindingConnection.prototype._resume=function(){this._pause===0?this._repeat():this._process()},JSJaCHttpBindingConnection.prototype._setHold=function(e){return!e||isNaN(e)||e<0?e=0:e>JSJACHBC_MAX_HOLD&&(e=JSJACHBC_MAX_HOLD),this._hold=e,this._hold},JSJaCHttpBindingConnection.prototype._setupRequest=function(e){var t={},n=XmlHttp.create();try{n.open("POST",this._httpbase,e),n.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(r){this.oDbg.log(r,1)}return t.r=n,this._rid++,t.rid=this._rid,t},JSJaCHttpBindingConnection.prototype._suspend=function(){if(this._pause===0)return;var e=this._getFreeSlot();this._req[e]=this._setupRequest(!1);var t="<body pause='"+this._pause+"' xmlns='http://jabber.org/protocol/httpbind' sid='"+this._sid+"' rid='"+this._rid+"'";JSJAC_HAVEKEYS&&(t+=" key='"+this._keys.getKey()+"'",this._keys.lastKey()&&(this._keys=new JSJaCKeys(hex_sha1,this.oDbg),t+=" newkey='"+this._keys.getKey()+"'")),t+=">";while(this._pQueue.length){var n=this._pQueue[0];t+=n,this._pQueue=this._pQueue.slice(1,this._pQueue.length)}t+="</body>",this.oDbg.log("Disconnecting: "+t,4),this._req[e].r.send(t)},JSJaCWebSocketConnection.prototype=new JSJaCConnection,JSJaCWebSocketConnection.prototype._cleanupWebSocket=function(){this._ws!==null&&(this._ws.onclose=null,this._ws.onerror=null,this._ws.onopen=null,this._ws.onmessage=null,this._ws.close(),this._ws=null)},JSJaCWebSocketConnection.prototype.connect=function(e){this._setStatus("connecting"),this.domain=e.domain||"localhost",this.username=e.username,this.resource=e.resource,this.pass=e.password||e.pass,this.register=e.register,this.authhost=e.authhost||this.domain,this.authtype=e.authtype||"sasl",this.jid=this.username+"@"+this.domain,this.fulljid=this.jid+"/"+this.resource,e.allow_plain?this._allow_plain=e.allow_plain:this._allow_plain=JSJAC_ALLOW_PLAIN,e.xmllang&&e.xmllang!==""?this._xmllang=e.xmllang:this._xmllang="en";if(typeof WebSocket=="undefined"){this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));return}this._ws=new WebSocket(this._httpbase,"xmpp"),this._ws.onclose=JSJaC.bind(this._onclose,this),this._ws.onerror=JSJaC.bind(this._onerror,this),this._ws.onopen=JSJaC.bind(this._onopen,this)},JSJaCWebSocketConnection.prototype._onopen=function(){var e=this._getInitialRequestString();this.oDbg.log(e,4),this._ws.onmessage=JSJaC.bind(this._handleOpenStream,this),this._ws.send(e)},JSJaCWebSocketConnection.prototype._handleOpenStream=function(e){var t,n;this.oDbg.log(e.data,4),t=e.data,t=t.substr(t.indexOf("<stream:stream")),t.substr(-2)!=="/>"&&t.substr(-16)!=="</stream:stream>"&&(t+="</stream:stream>"),n=this._parseXml(t);if(!n){this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));return}this.streamid=n.getAttribute("id"),this.oDbg.log("got streamid: "+this.streamid,2),this._ws.onmessage=JSJaC.bind(this._handleInitialResponse,this)},JSJaCWebSocketConnection.prototype._handleInitialResponse=function(e){var t=this._parseXml(e.data);if(!this._parseStreamFeatures(t)){this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"));return}this._connected=!0,this.register?this._doInBandReg():this._doAuth()},JSJaCWebSocketConnection.prototype.disconnect=function(){this._setStatus("disconnecting");if(!this.connected())return;this._connected=!1,this.oDbg.log("Disconnecting",4),this._sendRaw("</stream:stream>",JSJaC.bind(this._cleanupWebSocket,this)),this.oDbg.log("Disconnected",2),this._handleEvent("ondisconnect")},JSJaCWebSocketConnection.prototype._onclose=function(){this.oDbg.log("websocket closed",2),this._status!=="disconnecting"&&(this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable")))},JSJaCWebSocketConnection.prototype._onerror=function(){this.oDbg.log("websocket error",1),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","service-unavailable"))},JSJaCWebSocketConnection.prototype._onmessage=function(e){var t,n,r;t=e.data,this._setStatus("processing");if(!t||t==="")return;n=this._parseXml(t);if(n.namespaceURI===NS_STREAM&&n.localName==="error"){n.getElementsByTagNameNS(NS_STREAMS,"conflict").length>0&&this._setStatus("session-terminate-conflict"),this._connected=!1,this._handleEvent("onerror",JSJaCError("503","cancel","remote-stream-error"));return}r=JSJaCPacket.wrapNode(n);if(!r)return;this.oDbg.log("async recv: "+e.data,4),this._handleEvent("packet_in",r),r.pType&&!this._handlePID(r)&&(this._handleEvent(r.pType()+"_in",r),this._handleEvent(r.pType(),r))},JSJaCWebSocketConnection.prototype._parseXml=function(e){var t;this.oDbg.log("Parsing: "+e,4);try{return t=XmlDocument.create("stream",NS_STREAM),e.indexOf("<stream:stream")===-1?(t.loadXML("<stream:stream xmlns:stream='"+NS_STREAM+"' xmlns='jabber:client'>"+e+"</stream:stream>"),t.documentElement.firstChild):(t.loadXML(e),t.documentElement)}catch(n){this.oDbg.log("Error: "+n),this._connected=!1,this._handleEvent("onerror",JSJaCError("500","wait","internal-service-error"))}return null},JSJaCWebSocketConnection.prototype._getInitialRequestString=function(){var e,t;e=this.domain,this.authhost&&(e=this.authhost),t='<stream:stream to="'+e+'" xmlns="jabber:client" xmlns:stream="'+NS_STREAM+'"';if(this.authtype==="sasl"||this.authtype==="saslanon")t+=' version="1.0"';return t+=">",t},JSJaCWebSocketConnection.prototype.send=function(e,t,n){this._ws.onmessage=JSJaC.bind(this._onmessage,this);if(!e||!e.pType)return this.oDbg.log("no packet: "+e,1),!1;if(!this.connected())return!1;t&&(e.getID()||e.setID("JSJaCID_"+this._ID++),this._registerPID(e.getID(),t,n));try{this._handleEvent(e.pType()+"_out",e),this._handleEvent("packet_out",e),this._ws.send(e.xml())}catch(r){return this.oDbg.log(r.toString(),1),!1}return!0},JSJaCWebSocketConnection.prototype.resume=function(){return!1},JSJaCWebSocketConnection.prototype.suspend=function(){return!1},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S1=function(e){var t=this._parseXml(e.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S1,this)(t)},JSJaCWebSocketConnection.prototype._doSASLAuthDigestMd5S2=function(e){var t=this._parseXml(e.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDigestMd5S2,this)(t)},JSJaCWebSocketConnection.prototype._doSASLAuthDone=function(e){var t=this._parseXml(e.data);return JSJaC.bind(JSJaCConnection.prototype._doSASLAuthDone,this)(t)},JSJaCWebSocketConnection.prototype._reInitStream=function(e){var t,n=this.domain;this.authhost&&(n=this.authhost),t='<stream:stream xmlns:stream="'+NS_STREAM+'" xmlns="jabber:client" to="'+n+'" version="1.0">',this._sendRaw(t,e)},JSJaCWebSocketConnection.prototype._sendRaw=function(e,t,n){return this._ws?(t&&(this._ws.onmessage=JSJaC.bind(t,this,n)),this._ws.send(e),!0):!1},JSJaCFBApplication.prototype.Login=function(e,t){var n=this;FB.init({appId:this._appID,status:!0}),FB.login(function(r){r.session&&r.perms&&(n._perms=r.perms,n._session=r.session,e.connect(t))},{perms:"xmpp_login"})},JSJaCFBApplication.prototype.getAppID=function(){return this._appID},JSJaCFBApplication.prototype.getApiKey=function(){return this._apiKey},JSJaCFBApplication.prototype.getApiSecret=function(){return this._apiSecret},JSJaCFBApplication.prototype.getSession=function(){return this._session};var JSJaC={Version:"1.4",require:function(e){document.write('<script type="text/javascript" src="'+e+'"></script>')},load:function(){var e=["xmlextras","jsextras","crypt","JSJaCConfig","JSJaCConstants","JSJaCCookie","JSJaCJSON","JSJaCJID","JSJaCBuilder","JSJaCPacket","JSJaCError","JSJaCKeys","JSJaCConnection","JSJaCHttpPollingConnection","JSJaCHttpBindingConnection","JSJaCConsoleLogger","JSJaCFBApplication","JSJaCWebSocketConnection"],t=document.getElementsByTagName("script"),n="./",r;for(r=0;r<t.length;r++)if(t.item(r).src&&t.item(r).src.match(/JSJaC\.js$/)){n=t.item(r).src.replace(/JSJaC.js$/,"");break}for(r=0;r<e.length;r++)this.require(n+e[r]+".js")},bind:function(e,t,n){return function(r){return e.apply(t,[r,n])}}};typeof JSJaCConnection=="undefined"&&JSJaC.load(),function(){function t(){return function(){}}function D(){return"x"+ ++aa+""+ +(new Date)}function F(){return+(new Date)}function ka(e,t){var n=e.join(da),r=[];return t?(M(t,function(e,t){r.push(e+"="+N(t))}),n+="?"+r.join(ea)):n}function la(e,t){function n(){i+t>F()?(clearTimeout(r),r=setTimeout(n,t)):(i=F(),e())}var r,i=0;return n}function ma(e,t){var n=[];return M(e||[],function(e){t(e)&&n.push(e)}),n}function na(e,t){return e.replace(ha,function(e,n){return t[n]||e})}function ja(e){var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:t&3|8).toString(16)});return e&&e(t),t}function M(e,t){if(e&&t)if("undefined"!=typeof e[0])for(var n=0,r=e.length;n<r;)t.call(e[n],e[n],n++);else for(n in e)e.hasOwnProperty&&e.hasOwnProperty(n)&&t.call(e[n],n,e[n])}function P(e,t){var n=[];return M(e||[],function(e,r){n.push(t(e,r))}),n}function N(e){return P(encodeURIComponent(e).split(""),function(e){return 0>"-_.!~*'()".indexOf(e)?e:"%"+e.charCodeAt(0).toString(16).toUpperCase()}).join("")}function oa(e){var t=[];return M(e,function(e,n){n.j&&t.push(e)}),t.sort()}function pa(){setTimeout(function(){v||(v=1,M(ba,function(e){e()}))},z)}var n=null,r=!1;window.JSON&&window.JSON.stringify||function(){function a(){try{return this.valueOf()}catch(e){return n}}function c(e){return d.lastIndex=0,d.test(e)?'"'+e.replace(d,function(e){var t=q[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function b(t,n){var r,i,o,u,f,l=e,h=n[t];h&&"object"==typeof h&&(h=a.call(h)),"function"==typeof k&&(h=k.call(n,t,h));switch(typeof h){case"string":return c(h);case"number":return isFinite(h)?String(h):"null";case"boolean":case"null":return String(h);case"object":if(!h)return"null";e+=s,f=[];if("[object Array]"===Object.prototype.toString.apply(h)){u=h.length;for(r=0;r<u;r+=1)f[r]=b(r,h)||"null";return o=0===f.length?"[]":e?"[\n"+e+f.join(",\n"+e)+"\n"+l+"]":"["+f.join(",")+"]",e=l,o}if(k&&"object"==typeof k){u=k.length;for(r=0;r<u;r+=1)i=k[r],"string"==typeof i&&(o=b(i,h))&&f.push(c(i)+(e?": ":":")+o)}else for(i in h)Object.hasOwnProperty.call(h,i)&&(o=b(i,h))&&f.push(c(i)+(e?": ":":")+o);return o=0===f.length?"{}":e?"{\n"+e+f.join(",\n"+e)+"\n"+l+"}":"{"+f.join(",")+"}",e=l,o}}window.JSON||(window.JSON={});var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e,s,q={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},k;"function"!=typeof JSON.stringify&&(JSON.stringify=function(t,n,r){var i;s=e="";if("number"==typeof r)for(i=0;i<r;i+=1)s+=" ";else"string"==typeof r&&(s=r);if(!(k=n)||"function"==typeof n||"object"==typeof n&&"number"==typeof n.length)return b("",{"":t});throw Error("JSON.stringify")}),"function"!=typeof JSON.parse&&(JSON.parse=function(a){return eval("("+a+")")})}();var aa=1,v=r,ba=[],w="-pnpres",z=1e3,da="/",ea="&",ha=/{([\w\-]+)}/g,H,ia=Math.floor(20*Math.random());H=function(e,t){return 0<e.indexOf("pubsub.")&&e.replace("pubsub","ps"+(t?ja().split("-")[0]:20>++ia?ia:ia=1))||e};if(!window.PUBNUB){var Q=function(e){return document.getElementById(e)},qa=function(e){console.error(e)},ra=function(e,t){var n=[];return M(e.split(/\s+/),function(e){M((t||document).getElementsByTagName(e),function(e){n.push(e)})}),n},R=function(e,t,n){M(e.split(","),function(e){function i(e){e||(e=window.event),n(e)||(e.cancelBubble=!0,e.returnValue=r,e.preventDefault&&e.preventDefault(),e.stopPropagation&&e.stopPropagation())}t.addEventListener?t.addEventListener(e,i,r):t.attachEvent?t.attachEvent("on"+e,i):t["on"+e]=i})},sa=function(){return ra("head")[0]},S=function(e,t,n){if(!n)return e&&e.getAttribute&&e.getAttribute(t);e.setAttribute(t,n)},ua=function(e,t){for(var n in t)if(t.hasOwnProperty(n))try{e.style[n]=t[n]+(0<"|width|height|top|left|".indexOf(n)&&"number"==typeof t[n]?"px":"")}catch(r){}},va=function(e){return document.createElement(e)},wa=function(){return T||U()?0:D()},ya=function(e){function r(e,t){w||(w=1,y.onerror=n,clearTimeout(E),e||!t||N(t),setTimeout(function(){e&&x();var t=Q(b),n=t&&t.parentNode;n&&n.removeChild(t)},z))}if(T||U()){e:{var i,s,o=function(){if(!a){a=1,clearTimeout(l);try{s=JSON.parse(i.responseText)}catch(e){return v(1)}u=1,p(s)}},u=0,a=0,f=e.timeout||1e4,l=setTimeout(function(){v(1)},f),c=e.b||t(),h=e.data||{},p=e.c||t(),d="undefined"==typeof e.g,v=function(e){u||(u=1,clearTimeout(l),i&&(i.onerror=i.onload=n,i.abort&&i.abort(),i=n),e&&c())};try{i=U()||window.XDomainRequest&&new XDomainRequest||new XMLHttpRequest,i.onerror=i.onabort=function(){v(1)},i.onload=i.onloadend=o,d&&(i.timeout=f),h.pnsdk=xa;var m=ka(e.url,h);i.open("GET",m,d),i.send()}catch(g){v(0),T=0,e=ya(e);break e}e=v}return e}var y=va("script"),o=e.a,b=D(),w=0,E=setTimeout(function(){r(1)},e.timeout||1e4),x=e.b||t(),f=e.data||{},N=e.c||t();return window[o]=function(e){r(0,e)},e.g||(y[za]=za),y.onerror=function(){r(1)},f.pnsdk=xa,y.src=ka(e.url,f),S(y,"id",b),sa().appendChild(y),r},Aa=function(){return"onLine"in navigator?navigator.onLine:1},U=function(){if(!Ba||!Ba.get)return 0;var e={id:U.id++,send:t(),abort:function(){e.id={}},open:function(t,n){U[e.id]=e,Ba.get(e.id,n)}};return e},za="async",xa="PubNub-JS-Web/3.5.0",T=-1==navigator.userAgent.indexOf("MSIE 6");window.console||(window.console=window.console||{}),console.log||(console.log=console.error=(window.opera||{}).postError||t());var Ca,V=window.localStorage;Ca={get:function(e){try{return V?V.getItem(e):-1==document.cookie.indexOf(e)?n:((document.cookie||"").match(RegExp(e+"=([^;]+)"))||[])[1]||n}catch(t){}},set:function(e,t){try{if(V)return V.setItem(e,t)&&0;document.cookie=e+"="+t+"; expires=Thu, 1 Aug 2030 20:00:00 UTC; path=/"}catch(n){}}};var W={list:{},unbind:function(e){W.list[e]=[]},bind:function(e,t){(W.list[e]=W.list[e]||[]).push(t)},fire:function(e,t){M(W.list[e]||[],function(e){e(t)})}},Z=Q("pubnub")||0,Da=function(e){function r(){}function i(){A&&A(),A=n}function s(){$.time(function(e){e||i(),setTimeout(s,p)})}function o(){q()||i(),setTimeout(o,z)}function u(e){var n=0;return M(oa(B),function(r){if(r=B[r])n++,(e||t())(r)}),n}function a(e){e&&(C.h=0),!C.h&&C.length&&(C.h=1,j(C.shift()))}e.jsonp&&(T=0);var f=e.subscribe_key||"";e.uuid||Ca.get(f+"uuid"),e.xdr=ya,e.db=Ca,e.error=qa,e._is_online=Aa,e.jsonp_cb=wa;var l,c=+e.windowing||10,h=(+e.timeout||310)*z,p=(+e.keepalive||3600)*z,d=e.publish_key||"",m=e.subscribe_key||"",g=e.auth_key||"",y=e.ssl?"s":"",b="http"+y+"://"+(e.origin||"pubsub.pubnub.com"),E=H(b),x=H(b),C=[],k=0,L=0,A=0,O=0,_=0,B={},j=e.xdr,I=e.error||t(),q=e._is_online||function(){return 1},U=e.jsonp_cb||function(){return 0},X=e.db||{get:t(),set:t()},V=e.uuid||X&&X.get(m+"uuid")||"",$={LEAVE:function(e,t){var n={uuid:V,auth:g},r=H(b),i=U();0<e.indexOf(w)||("0"!=i&&(n.callback=i),j({g:t||y,timeout:2e3,a:i,data:n,url:[r,"v2","presence","sub_key",m,"channel",N(e),"leave"]}))},history:function(e,n){var n=e.callback||n,r=e.count||e.limit||100,i=e.reverse||"false",s=e.error||t(),o=e.channel,u=e.start,a=e.end,f={},l=U();if(!o)return I("Missing Channel");if(!n)return I("Missing Callback");if(!m)return I("Missing Subscribe Key");f.stringtoken="true",f.count=r,f.reverse=i,f.auth=g,l&&(f.callback=l),u&&(f.start=u),a&&(f.end=a),j({a:l,data:f,c:function(e){n(e)},b:s,url:[E,"v2","history","sub-key",m,"channel",N(o)]})},replay:function(e){var n=n||e.callback||t(),r=e.source,i=e.destination,s=e.stop,o=e.start,u=e.end,a=e.reverse,e=e.limit,f=U(),l={};if(!r)return I("Missing Source Channel");if(!i)return I("Missing Destination Channel");if(!d)return I("Missing Publish Key");if(!m)return I("Missing Subscribe Key");"0"!=f&&(l.callback=f),s&&(l.stop="all"),a&&(l.reverse="true"),o&&(l.start=o),u&&(l.end=u),e&&(l.count=e),l.auth=g,j({a:f,c:function(e){n(e)},b:function(){n([0,"Disconnected"])},url:[E,"v1","replay",d,m,r,i],data:l})},auth:function(e){g=e,r()},time:function(e){var t=U();j({a:t,data:{uuid:V,auth:g},timeout:5*z,url:[E,"time",t],c:function(t){e(t[0])},b:function(){e(0)}})},publish:function(e,n){var n=n||e.callback||t(),r=e.message,i=e.channel,s=U();if(!r)return I("Missing Message");if(!i)return I("Missing Channel");if(!d)return I("Missing Publish Key");if(!m)return I("Missing Subscribe Key");r=JSON.stringify(r),i=[E,"publish",d,m,0,N(i),s,N(r)],C.push({a:s,timeout:5*z,url:i,data:{uuid:V,auth:g},c:function(e){n(e),a(1)},b:function(){n([0,"Failed",r]),a(1)}}),a()},unsubscribe:function(e){e=e.channel,_=0,O=1,e=P((e.join?e.join(","):""+e).split(","),function(e){return e+","+e+w}).join(","),M(e.split(","),function(e){v&&$.LEAVE(e,0),B[e]=0}),r()},subscribe:function(e,s){function o(e){e?setTimeout(r,z):(E=H(b,1),x=H(b,1),setTimeout(function(){$.time(o)},z)),u(function(t){if(e&&t.d)return t.d=0,t.m(t.name);!e&&!t.d&&(t.d=1,t.l(t.name))})}function a(){var e=U(),t=oa(B).join(",");t&&(i(),A=j({timeout:D,a:e,b:function(){A=n,$.time(o)},data:{uuid:V,auth:g},url:[x,"subscribe",m,N(t),e,_],c:function(e){A=n;if(!e)return setTimeout(r,q);_=!_&&O&&X.get(m)||e[1],u(function(e){e.f||(e.f=1,e.k(e.name))}),T&&(_=1e4,T=0),X.set(m,e[1]);var t,i=(2<e.length?e[2]:P(B,function(t){return P(Array(e[0].length).join(",").split(","),function(){return t})}).join(",")).split(",");t=function(){var e=i.shift()||L;return[(B[e]||{}).a||k,e.split(w)[0]]},M(e[0],function(n){var r=t();r[0](n,e,r[1])}),setTimeout(a,q)}}))}var f=e.channel,s=(s=s||e.callback)||e.message,l=e.connect||t(),p=e.reconnect||t(),d=e.disconnect||t(),y=e.presence||0,S=e.noheresync||0,T=e.backfill||0,C=e.timetoken||0,D=e.timeout||h,q=e.windowing||c;O=e.restore,_=C;if(!f)return I("Missing Channel");if(!s)return I("Missing Callback");if(!m)return I("Missing Subscribe Key");M((f.join?f.join(","):""+f).split(","),function(e){var t=B[e]||{};B[L=e]={name:e,f:t.f,d:t.d,j:1,a:k=s,k:l,l:d,m:p},y&&($.subscribe({channel:e+w,callback:y}),!t.j&&!S&&$.here_now({channel:e,callback:function(t){M("uuids"in t?t.uuids:[],function(n){y({action:"join",uuid:n,timestamp:F(),occupancy:t.occupancy||1},t,e)})}}))}),r=function(){i(),setTimeout(a,q)};if(!v)return ba.push(r);r()},here_now:function(e,n){var n=e.callback||n,r=e.error||t(),i=e.channel,s=U(),o={uuid:V,auth:g};if(!i)return I("Missing Channel");if(!n)return I("Missing Callback");if(!m)return I("Missing Subscribe Key");"0"!=s&&(o.callback=s),j({a:s,data:o,c:function(e){n(e)},b:r,url:[E,"v2","presence","sub_key",m,"channel",N(i)]})},xdr:j,ready:pa,db:X,uuid:ja,map:P,each:M,"each-channel":u,grep:ma,offline:i,supplant:na,now:F,unique:D,updater:la};return V||(V=$.uuid()),X.set(m+"uuid",V),setTimeout(o,z),setTimeout(s,p),$.time(t()),l=$,l.css=ua,l.$=Q,l.create=va,l.bind=R,l.head=sa,l.search=ra,l.attr=S,l.events=W,l.init=Da,R("beforeunload",window,function(){return l["each-channel"](function(e){l.LEAVE(e.name,1)}),!0}),e.notest?l:(R("offline",window,l.offline),R("offline",document,l.offline),l)};R("load",window,function(){setTimeout(pa,0)});var $=Z||{};PUBNUB=Da({notest:1,publish_key:S($,"pub-key"),subscribe_key:S($,"sub-key"),ssl:!document.location.href.indexOf("https")||"on"==S($,"ssl"),origin:S($,"origin"),uuid:S($,"uuid")}),window.jQuery&&(window.jQuery.PUBNUB=PUBNUB),"undefined"!=typeof module&&(module.exports=PUBNUB)&&pa();var Ba=Q("pubnubs")||0;if(Z){ua(Z,{position:"absolute",top:-z});if("opera"in window||S(Z,"flash"))Z.innerHTML="<object id=pubnubs data=https://pubnub.a.ssl.fastly.net/pubnub.swf><param name=movie value=https://pubnub.a.ssl.fastly.net/pubnub.swf><param name=allowscriptaccess value=always></object>";PUBNUB.rdx=function(e,t){if(!t)return U[e].onerror();U[e].responseText=unescape(t),U[e].onload()},U.id=z}}var Ea=PUBNUB.ws=function(e,n){if(!(this instanceof Ea))return new Ea(e,n);var i=this,e=i.url=e||"";i.protocol=n||"Sec-WebSocket-Protocol";var s=e.split("/"),s={ssl:"wss:"===s[0],origin:s[2],publish_key:s[3],subscribe_key:s[4],channel:s[5]};i.CONNECTING=0,i.OPEN=1,i.CLOSING=2,i.CLOSED=3,i.CLOSE_NORMAL=1e3,i.CLOSE_GOING_AWAY=1001,i.CLOSE_PROTOCOL_ERROR=1002,i.CLOSE_UNSUPPORTED=1003,i.CLOSE_TOO_LARGE=1004,i.CLOSE_NO_STATUS=1005,i.CLOSE_ABNORMAL=1006,i.onclose=i.onerror=i.onmessage=i.onopen=i.onsend=t(),i.binaryType="",i.extensions="",i.bufferedAmount=0,i.trasnmitting=r,i.buffer=[],i.readyState=i.CONNECTING;if(!e)return i.readyState=i.CLOSED,i.onclose({code:i.CLOSE_ABNORMAL,reason:"Missing URL",wasClean:!0}),i;i.e=PUBNUB.init(s),i.e.i=s,i.i=s,i.e.subscribe({restore:r,channel:s.channel,disconnect:i.onerror,reconnect:i.onopen,error:function(){i.onclose({code:i.CLOSE_ABNORMAL,reason:"Missing URL",wasClean:r})},callback:function(e){i.onmessage({data:e})},connect:function(){i.readyState=i.OPEN,i.onopen()}})};Ea.prototype.send=function(e){var t=this;t.e.publish({channel:t.e.i.channel,message:e,callback:function(e){t.onsend({data:e})}})}}(),function(){function e(n,r){var i=this;this.options=r||{},this.key=n,this.channels=new e.Channels,this.global_emitter=new e.EventsDispatcher,this.sessionID=Math.floor(Math.random()*1e9),t(this.key),this.connection=new e.ConnectionManager(this.key,e.Util.extend({getStrategy:function(t){return e.StrategyBuilder.build(e.getDefaultStrategy(),e.Util.extend({},i.options,t))},getTimeline:function(){return new e.Timeline(i.key,i.sessionID,{features:e.Util.getClientFeatures(),params:i.options.timelineParams||{},limit:50,level:e.Timeline.INFO,version:e.VERSION})},getTimelineSender:function(t,n){return i.options.disableStats?null:new e.TimelineSender(t,{encrypted:i.isEncrypted()||!!n.encrypted,host:e.stats_host,path:"/timeline"})},activityTimeout:e.activity_timeout,pongTimeout:e.pong_timeout,unavailableTimeout:e.unavailable_timeout},this.options,{encrypted:this.isEncrypted()})),this.connection.bind("connected",function(){i.subscribeAll()}),this.connection.bind("message",function(e){var t=e.event.indexOf("pusher_internal:")===0;if(e.channel){var n=i.channel(e.channel);n&&n.emit(e.event,e.data)}t||i.global_emitter.emit(e.event,e.data)}),this.connection.bind("disconnected",function(){i.channels.disconnect()}),this.connection.bind("error",function(t){e.warn("Error",t)}),e.instances.push(this),e.isReady&&i.connect()}function t(t){(t===null||t===void 0)&&e.warn("Warning","You must pass your app key when you instantiate Pusher.")}var n=e.prototype;e.instances=[],e.isReady=!1,e.debug=function(){e.log&&e.log(e.Util.stringify.apply(this,arguments))},e.warn=function(){var t=e.Util.stringify.apply(this,arguments);window.console&&(window.console.warn?window.console.warn(t):window.console.log&&window.console.log(t)),e.log&&e.log(t)},e.ready=function(){e.isReady=!0;for(var t=0,n=e.instances.length;t<n;t++)e.instances[t].connect()},n.channel=function(e){return this.channels.find(e)},n.connect=function(){this.connection.connect()},n.disconnect=function(){this.connection.disconnect()},n.bind=function(e,t){return this.global_emitter.bind(e,t),this},n.bind_all=function(e){return this.global_emitter.bind_all(e),this},n.subscribeAll=function(){for(var e in this.channels.channels)this.channels.channels.hasOwnProperty(e)&&this.subscribe(e)},n.subscribe=function(e){var t=this,n=this.channels.add(e,this);return this.connection.state==="connected"&&n.authorize(this.connection.socket_id,this.options,function(r,i){r?n.emit("pusher:subscription_error",i):t.send_event("pusher:subscribe",{channel:e,auth:i.auth,channel_data:i.channel_data})}),n},n.unsubscribe=function(e){this.channels.remove(e),this.connection.state==="connected"&&this.send_event("pusher:unsubscribe",{channel:e})},n.send_event=function(e,t,n){return this.connection.send_event(e,t,n)},n.isEncrypted=function(){return e.Util.getDocumentLocation().protocol==="https:"?!0:!!this.options.encrypted},this.Pusher=e}.call(this),function(){Pusher.Util={now:function(){return Date.now?Date.now():(new Date).valueOf()},extend:function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t],r;for(r in n)e[r]=n[r]&&n[r].constructor&&n[r].constructor===Object?Pusher.Util.extend(e[r]||{},n[r]):n[r]}return e},stringify:function(){for(var e=["Pusher"],t=0;t<arguments.length;t++)typeof arguments[t]=="string"?e.push(arguments[t]):window.JSON===void 0?e.push(arguments[t].toString()):e.push(JSON.stringify(arguments[t]));return e.join(" : ")},arrayIndexOf:function(e,t){var n=Array.prototype.indexOf;if(e===null)return-1;if(n&&e.indexOf===n)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},keys:function(e){var t=[],n;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},apply:function(e,t){for(var n=0;n<e.length;n++)t(e[n],n,e)},objectApply:function(e,t){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(e[n],n,e)},map:function(e,t){for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r,e,n));return n},mapObject:function(e,t){var n={},r;for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=t(e[r]));return n},filter:function(e,t){for(var t=t||function(e){return!!e},n=[],r=0;r<e.length;r++)t(e[r],r,e,n)&&n.push(e[r]);return n},filterObject:function(e,t){var t=t||function(e){return!!e},n={},r;for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&t(e[r],r,e,n)&&(n[r]=e[r]);return n},flatten:function(e){var t=[],n;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push([n,e[n]]);return t},any:function(e,t){for(var n=0;n<e.length;n++)if(t(e[n],n,e))return!0;return!1},all:function(e,t){for(var n=0;n<e.length;n++)if(!t(e[n],n,e))return!1;return!0},method:function(e){var t=Array.prototype.slice.call(arguments,1);return function(n){return n[e].apply(n,t.concat(arguments))}},getDocument:function(){return document},getDocumentLocation:function(){return Pusher.Util.getDocument().location},getLocalStorage:function(){return window.localStorage},getClientFeatures:function(){return Pusher.Util.keys(Pusher.Util.filterObject({ws:Pusher.WSTransport,flash:Pusher.FlashTransport},function(e){return e.isSupported()}))}}}.call(this),function(){Pusher.VERSION="2.0.5",Pusher.PROTOCOL=6,Pusher.host="ws.pusherapp.com",Pusher.ws_port=80,Pusher.wss_port=443,Pusher.sockjs_host="sockjs.pusher.com",Pusher.sockjs_http_port=80,Pusher.sockjs_https_port=443,Pusher.sockjs_path="/pusher",Pusher.stats_host="stats.pusher.com",Pusher.channel_auth_endpoint="/pusher/auth",Pusher.cdn_http="http://js.pusher.com/",Pusher.cdn_https="https://d3dy5gmtp8yhk7.cloudfront.net/",Pusher.dependency_suffix=".min",Pusher.channel_auth_transport="ajax",Pusher.activity_timeout=12e4,Pusher.pong_timeout=3e4,Pusher.unavailable_timeout=1e4,Pusher.getDefaultStrategy=function(){return[[":def","ws_options",{hostUnencrypted:Pusher.host+":"+Pusher.ws_port,hostEncrypted:Pusher.host+":"+Pusher.wss_port}],[":def","sockjs_options",{hostUnencrypted:Pusher.sockjs_host+":"+Pusher.sockjs_http_port,hostEncrypted:Pusher.sockjs_host+":"+Pusher.sockjs_https_port}],[":def","timeouts",{loop:!0,timeout:15e3,timeoutLimit:6e4}],[":def","ws_manager",[":transport_manager",{lives:2}]],[":def_transport","ws","ws",3,":ws_options",":ws_manager"],[":def_transport","flash","flash",2,":ws_options",":ws_manager"],[":def_transport","sockjs","sockjs",1,":sockjs_options"],[":def","ws_loop",[":sequential",":timeouts",":ws"]],[":def","flash_loop",[":sequential",":timeouts",":flash"]],[":def","sockjs_loop",[":sequential",":timeouts",":sockjs"]],[":def","strategy",[":cached",18e5,[":first_connected",[":if",[":is_supported",":ws"],[":best_connected_ever",":ws_loop",[":delayed",2e3,[":sockjs_loop"]]],[":if",[":is_supported",":flash"],[":best_connected_ever",":flash_loop",[":delayed",2e3,[":sockjs_loop"]]],[":sockjs_loop"]]]]]]]}}.call(this),function(){function e(e){var t=function(t){Error.call(this,t),this.name=e};return Pusher.Util.extend(t.prototype,Error.prototype),t}Pusher.Errors={UnsupportedTransport:e("UnsupportedTransport"),UnsupportedStrategy:e("UnsupportedStrategy"),TransportPriorityTooLow:e("TransportPriorityTooLow"),TransportClosed:e("TransportClosed")}}.call(this),function(){function e(e){this.callbacks=new t,this.global_callbacks=[],this.failThrough=e}function t(){this._callbacks={}}var n=e.prototype;n.bind=function(e,t){return this.callbacks.add(e,t),this},n.bind_all=function(e){return this.global_callbacks.push(e),this},n.unbind=function(e,t){return this.callbacks.remove(e,t),this},n.emit=function(e,t){var n;for(n=0;n<this.global_callbacks.length;n++)this.global_callbacks[n](e,t);var r=this.callbacks.get(e);if(r&&r.length>0)for(n=0;n<r.length;n++)r[n](t);else this.failThrough&&this.failThrough(e,t);return this},t.prototype.get=function(e){return this._callbacks[this._prefix(e)]},t.prototype.add=function(e,t){var n=this._prefix(e);this._callbacks[n]=this._callbacks[n]||[],this._callbacks[n].push(t)},t.prototype.remove=function(e,t){if(this.get(e)){var n=Pusher.Util.arrayIndexOf(this.get(e),t);if(n!==-1){var r=this._callbacks[this._prefix(e)].slice(0);r.splice(n,1),this._callbacks[this._prefix(e)]=r}}},t.prototype._prefix=function(e){return"_"+e},Pusher.EventsDispatcher=e}.call(this),function(){function e(e){this.options=e,this.loading={},this.loaded={}}function t(e,t){Pusher.Util.getDocument().addEventListener?e.addEventListener("load",t,!1):e.attachEvent("onreadystatechange",function(){(e.readyState==="loaded"||e.readyState==="complete")&&t()})}function n(e,n){var r=Pusher.Util.getDocument(),i=r.getElementsByTagName("head")[0],r=r.createElement("script");r.setAttribute("src",e),r.setAttribute("type","text/javascript"),r.setAttribute("async",!0),t(r,function(){setTimeout(n,0)}),i.appendChild(r)}var r=e.prototype;r.load=function(e,t){var r=this;this.loaded[e]?t():(this.loading[e]||(this.loading[e]=[]),this.loading[e].push(t),this.loading[e].length>1||n(this.getPath(e),function(){for(var t=0;t<r.loading[e].length;t++)r.loading[e][t]();delete r.loading[e],r.loaded[e]=!0}))},r.getRoot=function(e){var t=Pusher.Util.getDocumentLocation().protocol;return(e&&e.encrypted||t==="https:"?this.options.cdn_https:this.options.cdn_http).replace(/\/*$/,"")+"/"+this.options.version},r.getPath=function(e,t){return this.getRoot(t)+"/"+e+this.options.suffix+".js"},Pusher.DependencyLoader=e}.call(this),function(){function e(){Pusher.ready()}function t(e){document.body?e():setTimeout(function(){t(e)},0)}function n(){t(e)}Pusher.Dependencies=new Pusher.DependencyLoader({cdn_http:Pusher.cdn_http,cdn_https:Pusher.cdn_https,version:Pusher.VERSION,suffix:Pusher.dependency_suffix}),!window.WebSocket&&window.MozWebSocket&&(window.WebSocket=window.MozWebSocket),window.JSON?n():Pusher.Dependencies.load("json2",n)}(),function(){function e(e,t){var n=this;this.timeout=setTimeout(function(){n.timeout!==null&&(t(),n.timeout=null)},e)}var t=e.prototype;t.isRunning=function(){return this.timeout!==null},t.ensureAborted=function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)},Pusher.Timer=e}.call(this),function(){for(var e=String.fromCharCode,t=0;t<64;t++)"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(t);var n=function(t){var n=t.charCodeAt(0);return n<128?t:n<2048?e(192|n>>>6)+e(128|n&63):e(224|n>>>12&15)+e(128|n>>>6&63)+e(128|n&63)},r=function(e){var t=[0,2,1][e.length%3],e=e.charCodeAt(0)<<16|(e.length>1?e.charCodeAt(1):0)<<8|(e.length>2?e.charCodeAt(2):0);return["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>18),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>12&63),t>=2?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>6&63),t>=1?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e&63)].join("")},i=window.btoa||function(e){return e.replace(/[\s\S]{1,3}/g,r)};Pusher.Base64={encode:function(e){return i(e.replace(/[^\x00-\x7F]/g,n))}}}.call(this),function(){function e(e){this.options=e}function t(e){return Pusher.Util.mapObject(e,function(e){return typeof e=="object"&&(e=JSON.stringify(e)),encodeURIComponent(Pusher.Base64.encode(e.toString()))})}e.send=function(e,t){var n=new Pusher.JSONPRequest({url:e.url,receiver:e.receiverName,tagPrefix:e.tagPrefix}),r=e.receiver.register(function(e,r){n.cleanup(),t(e,r)});return n.send(r,e.data,function(t){var n=e.receiver.unregister(r);n&&n(t)})};var n=e.prototype;n.send=function(e,n,r){if(this.script)return!1;var i=this.options.tagPrefix||"_pusher_jsonp_",n=Pusher.Util.extend({},n,{receiver:this.options.receiver}),n=Pusher.Util.map(Pusher.Util.flatten(t(Pusher.Util.filterObject(n,function(e){return e!==void 0}))),Pusher.Util.method("join","=")).join("&");this.script=document.createElement("script"),this.script.id=i+e,this.script.src=this.options.url+"/"+e+"?"+n,this.script.type="text/javascript",this.script.charset="UTF-8",this.script.onerror=this.script.onload=r,this.script.async===void 0&&document.attachEvent&&/opera/i.test(navigator.userAgent)&&(i=this.options.receiver||"Pusher.JSONP.receive",this.errorScript=document.createElement("script"),this.errorScript.text=i+"("+e+", true);",this.script.async=this.errorScript.async=!1);var s=this;return this.script.onreadystatechange=function(){s.script&&/loaded|complete/.test(s.script.readyState)&&r(!0)},e=document.getElementsByTagName("head")[0],e.insertBefore(this.script,e.firstChild),this.errorScript&&e.insertBefore(this.errorScript,this.script.nextSibling),!0},n.cleanup=function(){this.script&&this.script.parentNode&&(this.script.parentNode.removeChild(this.script),this.script=null),this.errorScript&&this.errorScript.parentNode&&(this.errorScript.parentNode.removeChild(this.errorScript),this.errorScript=null)},Pusher.JSONPRequest=e}.call(this),function(){function e(){this.lastId=0,this.callbacks={}}var t=e.prototype;t.register=function(e){this.lastId++;var t=this.lastId;return this.callbacks[t]=e,t},t.unregister=function(e){if(this.callbacks[e]){var t=this.callbacks[e];return delete this.callbacks[e],t}return null},t.receive=function(e,t,n){(e=this.unregister(e))&&e(t,n)},Pusher.JSONPReceiver=e,Pusher.JSONP=new e}.call(this),function(){function e(e,t,n){this.key=e,this.session=t,this.events=[],this.options=n||{},this.uniqueID=this.sent=0}var t=e.prototype;e.ERROR=3,e.INFO=6,e.DEBUG=7,t.log=function(e,t){if(this.options.level===void 0||e<=this.options.level)this.events.push(Pusher.Util.extend({},t,{timestamp:Pusher.Util.now(),level:e})),this.options.limit&&this.events.length>this.options.limit&&this.events.shift()},t.error=function(t){this.log(e.ERROR,t)},t.info=function(t){this.log(e.INFO,t)},t.debug=function(t){this.log(e.DEBUG,t)},t.isEmpty=function(){return this.events.length===0},t.send=function(e,t){var n=this,r={};return this.sent===0&&(r=Pusher.Util.extend({key:this.key,features:this.options.features,version:this.options.version},this.options.params||{})),r.session=this.session,r.timeline=this.events,r=Pusher.Util.filterObject(r,function(e){return e!==void 0}),this.events=[],e(r,function(e,r){e||n.sent++,t(e,r)}),!0},t.generateUniqueID=function(){return this.uniqueID++,this.uniqueID},Pusher.Timeline=e}.call(this),function(){function e(e,t){this.timeline=e,this.options=t||{}}var t=e.prototype;t.send=function(e){if(!this.timeline.isEmpty()){var t=this.options,n="http"+(this.isEncrypted()?"s":"")+"://";this.timeline.send(function(e,r){return Pusher.JSONPRequest.send({data:e,url:n+t.host+t.path,receiver:Pusher.JSONP},r)},e)}},t.isEncrypted=function(){return!!this.options.encrypted},Pusher.TimelineSender=e}.call(this),function(){function e(e){this.strategies=e}function t(e,t,n){var i=Pusher.Util.map(e,function(e,r,i,s){return e.connect(t,n(r,s))});return{abort:function(){Pusher.Util.apply(i,r)},forceMinPriority:function(e){Pusher.Util.apply(i,function(t){t.forceMinPriority(e)})}}}function n(e){return Pusher.Util.all(e,function(e){return Boolean(e.error)})}function r(e){!e.error&&!e.aborted&&(e.abort(),e.aborted=!0)}var i=e.prototype;i.isSupported=function(){return Pusher.Util.any(this.strategies,Pusher.Util.method("isSupported"))},i.connect=function(e,r){return t(this.strategies,e,function(e,t){return function(i,s){(t[e].error=i)?n(t)&&r(!0):(Pusher.Util.apply(t,function(e){e.forceMinPriority(s.transport.priority)}),r(null,s))}})},Pusher.BestConnectedEverStrategy=e}.call(this),function(){function e(e,t,n){this.strategy=e,this.transports=t,this.ttl=n.ttl||18e5,this.timeline=n.timeline}function t(){var e=Pusher.Util.getLocalStorage();return e&&e.pusherTransport?JSON.parse(e.pusherTransport):null}var n=e.prototype;n.isSupported=function(){return this.strategy.isSupported()},n.connect=function(e,n){var r=t(),i=[this.strategy];if(r&&r.timestamp+this.ttl>=Pusher.Util.now()){var s=this.transports[r.transport];s&&(this.timeline.info({cached:!0,transport:r.transport}),i.push(new Pusher.SequentialStrategy([s],{timeout:r.latency*2,failFast:!0})))}var o=Pusher.Util.now(),u=i.pop().connect(e,function a(t,r){if(t){var s=Pusher.Util.getLocalStorage();if(s&&s.pusherTransport)try{delete s.pusherTransport}catch(l){s.pusherTransport=void 0}i.length>0?(o=Pusher.Util.now(),u=i.pop().connect(e,a)):n(t)}else{var s=Pusher.Util.now()-o,c=r.transport.name,h=Pusher.Util.getLocalStorage();if(h)try{h.pusherTransport=JSON.stringify({timestamp:Pusher.Util.now(),transport:c,latency:s})}catch(p){}n(null,r)}});return{abort:function(){u.abort()},forceMinPriority:function(t){e=t,u&&u.forceMinPriority(t)}}},Pusher.CachedStrategy=e}.call(this),function(){function e(e,t){this.strategy=e,this.options={delay:t.delay}}var t=e.prototype;t.isSupported=function(){return this.strategy.isSupported()},t.connect=function(e,t){var n=this.strategy,r,i=new Pusher.Timer(this.options.delay,function(){r=n.connect(e,t)});return{abort:function(){i.ensureAborted(),r&&r.abort()},forceMinPriority:function(t){e=t,r&&r.forceMinPriority(t)}}},Pusher.DelayedStrategy=e}.call(this),function(){function e(e){this.strategy=e}var t=e.prototype;t.isSupported=function(){return this.strategy.isSupported()},t.connect=function(e,t){var n=this.strategy.connect(e,function(e,r){r&&n.abort(),t(e,r)});return n},Pusher.FirstConnectedStrategy=e}.call(this),function(){function e(e,t,n){this.test=e,this.trueBranch=t,this.falseBranch=n}var t=e.prototype;t.isSupported=function(){return(this.test()?this.trueBranch:this.falseBranch).isSupported()},t.connect=function(e,t){return(this.test()?this.trueBranch:this.falseBranch).connect(e,t)},Pusher.IfStrategy=e}.call(this),function(){function e(e,t){this.strategies=e,this.loop=Boolean(t.loop),this.failFast=Boolean(t.failFast),this.timeout=t.timeout,this.timeoutLimit=t.timeoutLimit}var t=e.prototype;t.isSupported=function(){return Pusher.Util.any(this.strategies,Pusher.Util.method("isSupported"))},t.connect=function(e,t){var n=this,r=this.strategies,i=0,s=this.timeout,o=null,u=function(l,h){h?t(null,h):(i+=1,n.loop&&(i%=r.length),i<r.length?(s&&(s*=2,n.timeoutLimit&&(s=Math.min(s,n.timeoutLimit))),o=n.tryStrategy(r[i],e,{timeout:s,failFast:n.failFast},u)):t(!0))},o=this.tryStrategy(r[i],e,{timeout:s,failFast:this.failFast},u);return{abort:function(){o.abort()},forceMinPriority:function(t){e=t,o&&o.forceMinPriority(t)}}},t.tryStrategy=function(e,t,n,r){var i=null,s=null,s=e.connect(t,function(e,t){if(!e||!i||!i.isRunning()||n.failFast)i&&i.ensureAborted(),r(e,t)});return n.timeout>0&&(i=new Pusher.Timer(n.timeout,function(){s.abort(),r(!0)})),{abort:function(){i&&i.ensureAborted(),s.abort()},forceMinPriority:function(e){s.forceMinPriority(e)}}},Pusher.SequentialStrategy=e}.call(this),function(){function e(e,t,n,r){this.name=e,this.priority=t,this.transport=n,this.options=r||{}}function t(e,t){return new Pusher.Timer(0,function(){t(e)}),{abort:function(){},forceMinPriority:function(){}}}var n=e.prototype;n.isSupported=function(){return this.transport.isSupported({disableFlash:!!this.options.disableFlash})},n.connect=function(e,n){if(!this.transport.isSupported())return t(new Pusher.Errors.UnsupportedStrategy,n);if(this.priority<e)return t(new Pusher.Errors.TransportPriorityTooLow,n);var r=this,i=!1,s=this.transport.createConnection(this.name,this.priority,this.options.key,this.options),o=null,u=function(){s.unbind("initialized",u),s.connect()},a=function(){o=new Pusher.Handshake(s,function(e){i=!0,h(),n(null,e)})},f=function(e){h(),n(e)},l=function(){h(),n(new Pusher.Errors.TransportClosed(s))},h=function(){s.unbind("initialized",u),s.unbind("open",a),s.unbind("error",f),s.unbind("closed",l)};return s.bind("initialized",u),s.bind("open",a),s.bind("error",f),s.bind("closed",l),s.initialize(),{abort:function(){i||(h(),o?o.close():s.close())},forceMinPriority:function(e){i||r.priority<e&&(o?o.close():s.close())}}},Pusher.TransportStrategy=e}.call(this),function(){function e(e,t,n,r){Pusher.EventsDispatcher.call(this),this.name=e,this.priority=t,this.key=n,this.state="new",this.timeline=r.timeline,this.id=this.timeline.generateUniqueID(),this.options={encrypted:Boolean(r.encrypted),hostUnencrypted:r.hostUnencrypted,hostEncrypted:r.hostEncrypted}}function t(e){return typeof e=="string"?e:typeof e=="object"?Pusher.Util.mapObject(e,function(e){var t=typeof e;return t==="object"||t=="function"?t:e}):typeof e}var n=e.prototype;Pusher.Util.extend(n,Pusher.EventsDispatcher.prototype),e.isSupported=function(){return!1},n.supportsPing=function(){return!1},n.initialize=function(){this.timeline.info(this.buildTimelineMessage({transport:this.name+(this.options.encrypted?"s":"")})),this.timeline.debug(this.buildTimelineMessage({method:"initialize"})),this.changeState("initialized")},n.connect=function(){var e=this.getURL(this.key,this.options);this.timeline.debug(this.buildTimelineMessage({method:"connect",url:e}));if(this.socket||this.state!=="initialized")return!1;try{this.socket=this.createSocket(e)}catch(t){var n=this;return new Pusher.Timer(0,function(){n.onError(t),n.changeState("closed")}),!1}return this.bindListeners(),Pusher.debug("Connecting",{transport:this.name,url:e}),this.changeState("connecting"),!0},n.close=function(){return this.timeline.debug(this.buildTimelineMessage({method:"close"})),this.socket?(this.socket.close(),!0):!1},n.send=function(e){this.timeline.debug(this.buildTimelineMessage({method:"send",data:e}));if(this.state==="open"){var t=this;return setTimeout(function(){t.socket.send(e)},0),!0}return!1},n.requestPing=function(){this.emit("ping_request")},n.onOpen=function(){this.changeState("open"),this.socket.onopen=void 0},n.onError=function(e){this.emit("error",{type:"WebSocketError",error:e}),this.timeline.error(this.buildTimelineMessage({error:t(e)}))},n.onClose=function(e){this.changeState("closed",e),this.socket=void 0},n.onMessage=function(e){this.timeline.debug(this.buildTimelineMessage({message:e.data})),this.emit("message",e)},n.bindListeners=function(){var e=this;this.socket.onopen=function(){e.onOpen()},this.socket.onerror=function(t){e.onError(t)},this.socket.onclose=function(t){e.onClose(t)},this.socket.onmessage=function(t){e.onMessage(t)}},n.createSocket=function(){return null},n.getScheme=function(){return this.options.encrypted?"wss":"ws"},n.getBaseURL=function(){var e;return e=this.options.encrypted?this.options.hostEncrypted:this.options.hostUnencrypted,this.getScheme()+"://"+e},n.getPath=function(){return"/app/"+this.key},n.getQueryString=function(){return"?protocol="+Pusher.PROTOCOL+"&client=js&version="+Pusher.VERSION},n.getURL=function(){return this.getBaseURL()+this.getPath()+this.getQueryString()},n.changeState=function(e,t){this.state=e,this.timeline.info(this.buildTimelineMessage({state:e,params:t})),this.emit(e,t)},n.buildTimelineMessage=function(e){return Pusher.Util.extend({cid:this.id},e)},Pusher.AbstractTransport=e}.call(this),function(){function e(e,t,n,r){Pusher.AbstractTransport.call(this,e,t,n,r)}var t=e.prototype;Pusher.Util.extend(t,Pusher.AbstractTransport.prototype),e.createConnection=function(t,n,r,i){return new e(t,n,r,i)},e.isSupported=function(e){if(e&&e.disableFlash)return!1;try{return Boolean(new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(t){return Boolean(navigator&&navigator.mimeTypes&&navigator.mimeTypes["application/x-shockwave-flash"]!==void 0)}},t.initialize=function(){var e=this;this.timeline.info(this.buildTimelineMessage({transport:this.name+(this.options.encrypted?"s":"")})),this.timeline.debug(this.buildTimelineMessage({method:"initialize"})),this.changeState("initializing"),window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR===void 0&&(window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=!0),window.WEB_SOCKET_SWF_LOCATION=Pusher.Dependencies.getRoot()+"/WebSocketMain.swf",Pusher.Dependencies.load("flashfallback",function(){e.changeState("initialized")})},t.createSocket=function(e){return new FlashWebSocket(e)},t.getQueryString=function(){return Pusher.AbstractTransport.prototype.getQueryString.call(this)+"&flash=true"},Pusher.FlashTransport=e}.call(this),function(){function e(e,t,n,r){Pusher.AbstractTransport.call(this,e,t,n,r),this.options.ignoreNullOrigin=r.ignoreNullOrigin}var t=e.prototype;Pusher.Util.extend(t,Pusher.AbstractTransport.prototype),e.createConnection=function(t,n,r,i){return new e(t,n,r,i)},e.isSupported=function(){return!0},t.initialize=function(){var e=this;this.timeline.info(this.buildTimelineMessage({transport:this.name+(this.options.encrypted?"s":"")})),this.timeline.debug(this.buildTimelineMessage({method:"initialize"})),this.changeState("initializing"),Pusher.Dependencies.load("sockjs",function(){e.changeState("initialized")})},t.supportsPing=function(){return!0},t.createSocket=function(e){return new SockJS(e,null,{js_path:Pusher.Dependencies.getPath("sockjs",{encrypted:this.options.encrypted}),ignore_null_origin:this.options.ignoreNullOrigin})},t.getScheme=function(){return this.options.encrypted?"https":"http"},t.getPath=function(){return"/pusher"},t.getQueryString=function(){return""},t.onOpen=function(){this.socket.send(JSON.stringify({path:Pusher.AbstractTransport.prototype.getPath.call(this)+Pusher.AbstractTransport.prototype.getQueryString.call(this)})),this.changeState("open"),this.socket.onopen=void 0},Pusher.SockJSTransport=e}.call(this),function(){function e(e,t,n,r){Pusher.AbstractTransport.call(this,e,t,n,r)}var t=e.prototype;Pusher.Util.extend(t,Pusher.AbstractTransport.prototype),e.createConnection=function(t,n,r,i){return new e(t,n,r,i)},e.isSupported=function(){return window.WebSocket!==void 0||window.MozWebSocket!==void 0},t.createSocket=function(e){return new(window.WebSocket||window.MozWebSocket)(e)},t.getQueryString=function(){return Pusher.AbstractTransport.prototype.getQueryString.call(this)+"&flash=false"},Pusher.WSTransport=e}.call(this),function(){function e(e,t,n){this.manager=e,this.transport=t,this.minPingDelay=n.minPingDelay||1e4,this.maxPingDelay=n.maxPingDelay||Pusher.activity_timeout,this.pingDelay=null}var t=e.prototype;t.createConnection=function(e,t,n,r){var i=this.transport.createConnection(e,t,n,r),s=this,o=null,u=null,a=function(){i.unbind("open",a),o=Pusher.Util.now(),s.pingDelay&&(u=setInterval(function(){u&&i.requestPing()},s.pingDelay)),i.bind("closed",f)},f=function(e){i.unbind("closed",f),u&&(clearInterval(u),u=null),!e.wasClean&&o&&(e=Pusher.Util.now()-o,e<2*s.maxPingDelay)&&(s.manager.reportDeath(),s.pingDelay=Math.max(e/2,s.minPingDelay))};return i.bind("open",a),i},t.isSupported=function(e){return this.manager.isAlive()&&this.transport.isSupported(e)},Pusher.AssistantToTheTransportManager=e}.call(this),function(){function e(e){this.options=e||{},this.livesLeft=this.options.lives||Infinity}var t=e.prototype;t.getAssistant=function(e){return new Pusher.AssistantToTheTransportManager(this,e,{minPingDelay:this.options.minPingDelay,maxPingDelay:this.options.maxPingDelay})},t.isAlive=function(){return this.livesLeft>0},t.reportDeath=function(){this.livesLeft-=1},Pusher.TransportManager=e}.call(this),function(){function e(e){return function(t){return[e.apply(this,arguments),t]}}function t(e,n){if(e.length===0)return[[],n];var i=r(e[0],n),s=t(e.slice(1),i[1]);return[[i[0]].concat(s[0]),s[1]]}function n(e,n){if(typeof e[0]=="string"&&e[0].charAt(0)===":"){var i=n[e[0].slice(1)];if(e.length>1){if(typeof i!="function")throw"Calling non-function "+e[0];var s=[Pusher.Util.extend({},n)].concat(Pusher.Util.map(e.slice(1),function(e){return r(e,Pusher.Util.extend({},n))[0]}));return i.apply(this,s)}return[i,n]}return t(e,n)}function r(e,t){if(typeof e=="string"){var r;if(typeof e=="string"&&e.charAt(0)===":"){r=t[e.slice(1)];if(r===void 0)throw"Undefined symbol "+e;r=[r,t]}else r=[e,t];return r}return typeof e=="object"&&e instanceof Array&&e.length>0?n(e,t):[e,t]}var i={ws:Pusher.WSTransport,flash:Pusher.FlashTransport,sockjs:Pusher.SockJSTransport},s={def:function(e,t,n){if(e[t]!==void 0)throw"Redefining symbol "+t;return e[t]=n,[void 0,e]},def_transport:function(e,t,n,r,s,o){var u=i[n];if(!u)throw new Pusher.Errors.UnsupportedTransport(n);return n=Pusher.Util.extend({},{key:e.key,encrypted:e.encrypted,timeline:e.timeline,disableFlash:e.disableFlash,ignoreNullOrigin:e.ignoreNullOrigin},s),o&&(u=o.getAssistant(u)),r=new Pusher.TransportStrategy(t,r,u,n),o=e.def(e,t,r)[1],o.transports=e.transports||{},o.transports[t]=r,[void 0,o]},transport_manager:e(function(e,t){return new Pusher.TransportManager(t)}),sequential:e(function(e,t){var n=Array.prototype.slice.call(arguments,2);return new Pusher.SequentialStrategy(n,t)}),cached:e(function(e,t,n){return new Pusher.CachedStrategy(n,e.transports,{ttl:t,timeline:e.timeline})}),first_connected:e(function(e,t){return new Pusher.FirstConnectedStrategy(t)}),best_connected_ever:e(function(){var e=Array.prototype.slice.call(arguments,1);return new Pusher.BestConnectedEverStrategy(e)}),delayed:e(function(e,t,n){return new Pusher.DelayedStrategy(n,{delay:t})}),"if":e(function(e,t,n,r){return new Pusher.IfStrategy(t,n,r)}),is_supported:e(function(e,t){return function(){return t.isSupported()}})};Pusher.StrategyBuilder={build:function(e,t){var n=Pusher.Util.extend({},s,t);return r(e,n)[1].strategy}}}.call(this),function(){Protocol={decodeMessage:function(e){try{var t=JSON.parse(e.data);if(typeof t.data=="string")try{t.data=JSON.parse(t.data)}catch(n){if(!(n instanceof SyntaxError))throw n}return t}catch(r){throw{type:"MessageParseError",error:r,data:e.data}}},encodeMessage:function(e){return JSON.stringify(e)},processHandshake:function(e){e=this.decodeMessage(e);if(e.event==="pusher:connection_established")return{action:"connected",id:e.data.socket_id};if(e.event==="pusher:error")return{action:this.getCloseAction(e.data),error:this.getCloseError(e.data)};throw"Invalid handshake"},getCloseAction:function(e){return e.code<4e3?e.code>=1002&&e.code<=1004?"backoff":null:e.code===4e3?"ssl_only":e.code<4100?"refused":e.code<4200?"backoff":e.code<4300?"retry":"refused"},getCloseError:function(e){return e.code!==1e3&&e.code!==1001?{type:"PusherError",data:{code:e.code,message:e.reason||e.message}}:null}},Pusher.Protocol=Protocol}.call(this),function(){function e(e,t){Pusher.EventsDispatcher.call(this),this.id=e,this.transport=t,this.bindListeners()}var t=e.prototype;Pusher.Util.extend(t,Pusher.EventsDispatcher.prototype),t.supportsPing=function(){return this.transport.supportsPing()},t.send=function(e){return this.transport.send(e)},t.send_event=function(e,t,n){return e={event:e,data:t},n&&(e.channel=n),Pusher.debug("Event sent",e),this.send(Pusher.Protocol.encodeMessage(e))},t.close=function(){this.transport.close()},t.bindListeners=function(){var e=this,t=function(t){var n;try{n=Pusher.Protocol.decodeMessage(t)}catch(r){e.emit("error",{type:"MessageParseError",error:r,data:t.data})}if(n!==void 0){Pusher.debug("Event recd",n);switch(n.event){case"pusher:error":e.emit("error",{type:"PusherError",data:n.data});break;case"pusher:ping":e.emit("ping");break;case"pusher:pong":e.emit("pong")}e.emit("message",n)}},n=function(){e.emit("ping_request")},r=function(t){e.emit("error",{type:"WebSocketError",error:t})},i=function(s){e.transport.unbind("closed",i),e.transport.unbind("error",r),e.transport.unbind("ping_request",n),e.transport.unbind("message",t),s&&s.code&&e.handleCloseEvent(s),e.transport=null,e.emit("closed")};e.transport.bind("message",t),e.transport.bind("ping_request",n),e.transport.bind("error",r),e.transport.bind("closed",i)},t.handleCloseEvent=function(e){var t=Pusher.Protocol.getCloseAction(e);(e=Pusher.Protocol.getCloseError(e))&&this.emit("error",e),t&&this.emit(t)},Pusher.Connection=e}.call(this),function(){function e(e,t){this.transport=e,this.callback=t,this.bindListeners()}var t=e.prototype;t.close=function(){this.unbindListeners(),this.transport.close()},t.bindListeners=function(){var e=this;e.onMessage=function(t){e.unbindListeners();try{var n=Pusher.Protocol.processHandshake(t);n.action==="connected"?e.finish("connected",{connection:new Pusher.Connection(n.id,e.transport)}):(e.finish(n.action,{error:n.error}),e.transport.close())}catch(r){e.finish("error",{error:r}),e.transport.close()}},e.onClosed=function(t){e.unbindListeners();var n=Pusher.Protocol.getCloseAction(t)||"backoff",t=Pusher.Protocol.getCloseError(t);e.finish(n,{error:t})},e.transport.bind("message",e.onMessage),e.transport.bind("closed",e.onClosed)},t.unbindListeners=function(){this.transport.unbind("message",this.onMessage),this.transport.unbind("closed",this.onClosed)},t.finish=function(e,t){this.callback(Pusher.Util.extend({transport:this.transport,action:e},t))},Pusher.Handshake=e}.call(this),function(){function e(e,t){Pusher.EventsDispatcher.call(this),this.key=e,this.options=t||{},this.state="initialized",this.connection=null,this.encrypted=!!t.encrypted,this.timeline=this.options.getTimeline(),this.connectionCallbacks=this.buildConnectionCallbacks(),this.errorCallbacks=this.buildErrorCallbacks(),this.handshakeCallbacks=this.buildHandshakeCallbacks(this.errorCallbacks);var n=this;Pusher.Network.bind("online",function(){n.timeline.info({netinfo:"online"}),n.state==="unavailable"&&n.connect()}),Pusher.Network.bind("offline",function(){n.timeline.info({netinfo:"offline"}),n.shouldRetry()&&(n.disconnect(),n.updateState("unavailable"))});var r=function(){n.timelineSender&&n.timelineSender.send(function(){})};this.bind("connected",r),setInterval(r,6e4),this.updateStrategy()}var t=e.prototype;Pusher.Util.extend(t,Pusher.EventsDispatcher.prototype),t.connect=function(){var e=this;if(!e.connection&&e.state!=="connecting")if(e.strategy.isSupported())if(Pusher.Network.isOnline()===!1)e.updateState("unavailable");else{e.updateState("connecting"),e.timelineSender=e.options.getTimelineSender(e.timeline,{encrypted:e.encrypted},e);var t=function(n,r){n?e.runner=e.strategy.connect(0,t):(e.runner.abort(),e.handshakeCallbacks[r.action](r))};e.runner=e.strategy.connect(0,t),e.setUnavailableTimer()}else e.updateState("failed")},t.send=function(e){return this.connection?this.connection.send(e):!1},t.send_event=function(e,t,n){return this.connection?this.connection.send_event(e,t,n):!1},t.disconnect=function(){this.runner&&this.runner.abort(),this.clearRetryTimer(),this.clearUnavailableTimer(),this.stopActivityCheck(),this.updateState("disconnected"),this.connection&&(this.connection.close(),this.abandonConnection())},t.updateStrategy=function(){this.strategy=this.options.getStrategy({key:this.key,timeline:this.timeline,encrypted:this.encrypted})},t.retryIn=function(e){var t=this;t.timeline.info({action:"retry",delay:e}),t.retryTimer=new Pusher.Timer(e||0,function(){t.disconnect(),t.connect()})},t.clearRetryTimer=function(){this.retryTimer&&this.retryTimer.ensureAborted()},t.setUnavailableTimer=function(){var e=this;e.unavailableTimer=new Pusher.Timer(e.options.unavailableTimeout,function(){e.updateState("unavailable")})},t.clearUnavailableTimer=function(){this.unavailableTimer&&this.unavailableTimer.ensureAborted()},t.resetActivityCheck=function(){this.stopActivityCheck();if(!this.connection.supportsPing()){var e=this;e.activityTimer=new Pusher.Timer(e.options.activityTimeout,function(){e.send_event("pusher:ping",{}),e.activityTimer=new Pusher.Timer(e.options.pongTimeout,function(){e.connection.close()})})}},t.stopActivityCheck=function(){this.activityTimer&&this.activityTimer.ensureAborted()},t.buildConnectionCallbacks=function(){var e=this;return{message:function(t){e.resetActivityCheck(),e.emit("message",t)},ping:function(){e.send_event("pusher:pong",{})},ping_request:function(){e.send_event("pusher:ping",{})},error:function(t){e.emit("error",{type:"WebSocketError",error:t})},closed:function(){e.abandonConnection(),e.shouldRetry()&&e.retryIn(1e3)}}},t.buildHandshakeCallbacks=function(e){var t=this;return Pusher.Util.extend({},e,{connected:function(e){t.clearUnavailableTimer(),t.setConnection(e.connection),t.socket_id=t.connection.id,t.updateState("connected")}})},t.buildErrorCallbacks=function(){function e(e){return function(n){n.error&&t.emit("error",{type:"WebSocketError",error:n.error}),e(n)}}var t=this;return{ssl_only:e(function(){t.encrypted=!0,t.updateStrategy(),t.retryIn(0)}),refused:e(function(){t.disconnect()}),backoff:e(function(){t.retryIn(1e3)}),retry:e(function(){t.retryIn(0)})}},t.setConnection=function(e){this.connection=e;for(var t in this.connectionCallbacks)this.connection.bind(t,this.connectionCallbacks[t]);this.resetActivityCheck()},t.abandonConnection=function(){if(this.connection){for(var e in this.connectionCallbacks)this.connection.unbind(e,this.connectionCallbacks[e]);this.connection=null}},t.updateState=function(e,t){var n=this.state;this.state=e,n!==e&&(Pusher.debug("State changed",n+" -> "+e),this.timeline.info({state:e}),this.emit("state_change",{previous:n,current:e}),this.emit(e,t))},t.shouldRetry=function(){return this.state==="connecting"||this.state==="connected"},Pusher.ConnectionManager=e}.call(this),function(){function e(){Pusher.EventsDispatcher.call(this);var e=this;window.addEventListener!==void 0&&(window.addEventListener("online",function(){e.emit("online")},!1),window.addEventListener("offline",function(){e.emit("offline")},!1))}Pusher.Util.extend(e.prototype,Pusher.EventsDispatcher.prototype),e.prototype.isOnline=function(){return window.navigator.onLine===void 0?!0:window.navigator.onLine},Pusher.NetInfo=e,Pusher.Network=new e}.call(this),function(){Pusher.Channels=function(){this.channels={}},Pusher.Channels.prototype={add:function(e,t){var n=this.find(e);return n||(n=Pusher.Channel.factory(e,t),this.channels[e]=n),n},find:function(e){return this.channels[e]},remove:function(e){delete this.channels[e]},disconnect:function(){for(var e in this.channels)this.channels[e].disconnect()}},Pusher.Channel=function(e,t){var n=this;Pusher.EventsDispatcher.call(this,function(t){Pusher.debug("No callbacks on "+e+" for "+t)}),this.pusher=t,this.name=e,this.subscribed=!1,this.bind("pusher_internal:subscription_succeeded",function(e){n.onSubscriptionSucceeded(e)})},Pusher.Channel.prototype={init:function(){},disconnect:function(){this.subscribed=!1,this.emit("pusher_internal:disconnected")},onSubscriptionSucceeded:function(){this.subscribed=!0,this.emit("pusher:subscription_succeeded")},authorize:function(e,t,n){return n(!1,{})},trigger:function(e,t){return this.pusher.send_event(e,t,this.name)}},Pusher.Util.extend(Pusher.Channel.prototype,Pusher.EventsDispatcher.prototype),Pusher.Channel.PrivateChannel={authorize:function(e,t,n){var r=this;return(new Pusher.Channel.Authorizer(this,Pusher.channel_auth_transport,t)).authorize(e,function(e,t){e||r.emit("pusher_internal:authorized",t),n(e,t)})}},Pusher.Channel.PresenceChannel={init:function(){this.members=new e(this)},onSubscriptionSucceeded:function(){this.subscribed=!0}};var e=function(e){var t=this,n=null,r=function(){t._members_map={},t.count=0,n=t.me=null};r();var i=function(r){t._members_map=r.presence.hash,t.count=r.presence.count,t.me=t.get(n.user_id),e.emit("pusher:subscription_succeeded",t)};e.bind("pusher_internal:authorized",function(t){n=JSON.parse(t.channel_data),e.bind("pusher_internal:subscription_succeeded",i)}),e.bind("pusher_internal:member_added",function(n){t.get(n.user_id)===null&&t.count++,t._members_map[n.user_id]=n.user_info,e.emit("pusher:member_added",t.get(n.user_id))}),e.bind("pusher_internal:member_removed",function(n){var r=t.get(n.user_id);r&&(delete t._members_map[n.user_id],t.count--,e.emit("pusher:member_removed",r))}),e.bind("pusher_internal:disconnected",function(){r(),e.unbind("pusher_internal:subscription_succeeded",i)})};e.prototype={each:function(e){for(var t in this._members_map)e(this.get(t))},get:function(e){return this._members_map.hasOwnProperty(e)?{id:e,info:this._members_map[e]}:null}},Pusher.Channel.factory=function(e,t){var n=new Pusher.Channel(e,t);return e.indexOf("private-")===0?Pusher.Util.extend(n,Pusher.Channel.PrivateChannel):e.indexOf("presence-")===0&&(Pusher.Util.extend(n,Pusher.Channel.PrivateChannel),Pusher.Util.extend(n,Pusher.Channel.PresenceChannel)),n.init(),n}}.call(this),function(){Pusher.Channel.Authorizer=function(e,t,n){this.channel=e,this.type=t,this.authOptions=(n||{}).auth||{}},Pusher.Channel.Authorizer.prototype={composeQuery:function(e){var e="&socket_id="+encodeURIComponent(e)+"&channel_name="+encodeURIComponent(this.channel.name),t;for(t in this.authOptions.params)e+="&"+encodeURIComponent(t)+"="+encodeURIComponent(this.authOptions.params[t]);return e},authorize:function(e,t){return Pusher.authorizers[this.type].call(this,e,t)}};var e=1;Pusher.auth_callbacks={},Pusher.authorizers={ajax:function(e,t){var n;n=Pusher.XHR?new Pusher.XHR:window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),n.open("POST",Pusher.channel_auth_endpoint,!0),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded");for(var r in this.authOptions.headers)n.setRequestHeader(r,this.authOptions.headers[r]);return n.onreadystatechange=function(){if(n.readyState==4)if(n.status==200){var e,r=!1;try{e=JSON.parse(n.responseText),r=!0}catch(i){t(!0,"JSON returned from webapp was invalid, yet status code was 200. Data was: "+n.responseText)}r&&t(!1,e)}else Pusher.warn("Couldn't get auth info from your webapp",n.status),t(!0,n.status)},n.send(this.composeQuery(e)),n},jsonp:function(t,n){this.authOptions.headers!==void 0&&Pusher.warn("Warn","To send headers with the auth request, you must use AJAX, rather than JSONP.");var r=e.toString();e++;var i=document.createElement("script");Pusher.auth_callbacks[r]=function(e){n(!1,e)},i.src=Pusher.channel_auth_endpoint+"?callback="+encodeURIComponent("Pusher.auth_callbacks['"+r+"']")+this.composeQuery(t),r=document.getElementsByTagName("head")[0]||document.documentElement,r.insertBefore(i,r.firstChild)}}}.call(this),WebP2P.prototype=new EventTarget,exports.WebP2P=WebP2P;var ERROR_NETWORK_UNKNOWN={id:0,msg:"Unable to fetch handshake servers configuration"},ERROR_NETWORK_OFFLINE={id:1,msg:"There's no available network"},ERROR_REQUEST_FAILURE={id:2,msg:"Unable to fetch handshake servers configuration"},ERROR_REQUEST_EMPTY={id:3,msg:"Handshake servers configuration is empty"},ERROR_NO_PEERS={id:4,msg:"Not connected to any peer"};HandshakeManager.prototype=new EventTarget,HandshakeManager.handshakeServers={},HandshakeManager.registerConstructor=function(e,t){HandshakeManager.handshakeServers[e]=t},HandshakeConnector.prototype=new EventTarget,Handshake_PubNub.prototype=new HandshakeConnector,Handshake_PubNub.prototype.constructor=Handshake_PubNub,HandshakeManager.registerConstructor("PubNub",Handshake_PubNub),Handshake_SimpleSignaling.prototype=new HandshakeConnector,Handshake_SimpleSignaling.prototype.constructor=Handshake_SimpleSignaling,HandshakeManager.registerConstructor("SimpleSignaling",Handshake_SimpleSignaling),Handshake_XMPP.prototype=new HandshakeConnector,Handshake_XMPP.prototype.constructor=Handshake_XMPP,HandshakeManager.registerConstructor("XMPP",Handshake_XMPP)})(this)